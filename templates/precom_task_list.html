{% extends "base_industrial.html" %}

{% block title %}{{ page_title or 'é¢„è¯•è½¦ä»»åŠ¡ - é¢„è¯•è½¦ç®¡ç†ç³»ç»Ÿ' }}{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-end">
    <div>
        <h1>
            <i class="bi bi-clipboard-check"></i>
            {{ page_title or 'é¢„è¯•è½¦ä»»åŠ¡ç®¡ç†' }}
        </h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/"><i class="bi bi-house-door"></i> {{ _('é¦–é¡µ') }}</a></li>
                <li class="breadcrumb-item active">{{ _('é¢„è¯•è½¦ä»»åŠ¡ç®¡ç†') }}</li>
            </ol>
        </nav>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ new_task_url }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> {{ _('æ–°å»ºä»»åŠ¡') }}
        </a>
        <a href="{{ url_for('precom.precom_export_tasks', task_type=filter_task_type) }}" class="btn btn-outline-success">
            <i class="bi bi-download"></i> {{ _('å¯¼å‡ºä»»åŠ¡æ¸…å•') }}
        </a>
        <form class="d-inline-block" method="post" enctype="multipart/form-data"
              action="{{ url_for('precom.precom_import_tasks', task_type=filter_task_type) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <label class="btn btn-outline-secondary mb-0">
                <i class="bi bi-upload"></i> {{ _('å¯¼å…¥æ¸…å•') }}
                <input type="file" name="file" accept=".xlsx,.xls" style="display:none" onchange="this.form.submit();">
            </label>
        </form>
    </div>
</div>

<!-- ç­›é€‰åŒº -->
<div class="filter-section mb-3">
    <form method="get" action="{{ url_for('precom.precom_task_list') }}">
        <div class="row g-2">
            <div class="col-md-2">
                <select class="form-select" name="task_type">
                    <option value="">{{ _('å…¨éƒ¨ä»»åŠ¡ç±»å‹') }}</option>
                    {% set types = [
                        ('Manhole', _('äººå­”æ£€æŸ¥')),
                        ('MotorSolo', _('ç”µæœºå•è¯•')),
                        ('SkidInstall', _('ä»ªè¡¨å°ä»¶å®‰è£…')),
                        ('LoopTest', _('å›è·¯æµ‹è¯•')),
                        ('Alignment', _('åŠ¨è®¾å¤‡æœ€ç»ˆå¯¹ä¸­')),
                        ('MRT', _('MRTæœºæ¢°è”åŠ¨æµ‹è¯•')),
                        ('FunctionTest', 'Function Test')
                    ] %}
                    {% for code, label in types %}
                    <option value="{{ code }}" {% if filter_task_type == code %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" name="system_code" id="precomTaskSystemCodeInput"
                       placeholder="å…¨éƒ¨ç³»ç»Ÿ" value="{{ filter_system }}"
                       list="precomTaskSystemCodeAutocompleteList" autocomplete="off">
                <datalist id="precomTaskSystemCodeAutocompleteList"></datalist>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" name="subsystem_code" id="precomTaskSubsystemCodeInput"
                       placeholder="å…¨éƒ¨å­ç³»ç»Ÿ" value="{{ filter_subsystem }}"
                       list="precomTaskSubsystemCodeAutocompleteList" autocomplete="off">
                <datalist id="precomTaskSubsystemCodeAutocompleteList"></datalist>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" name="block" placeholder="Block / åŒºåŸŸ"
                       value="{{ filter_block }}">
            </div>
            <div class="col-md-2">
                <select class="form-select" name="status">
                    <option value="">{{ _('å…¨éƒ¨çŠ¶æ€') }}</option>
                    <option value="æœªå¼€å§‹" {% if filter_status == 'æœªå¼€å§‹' %}selected{% endif %}>{{ _('æœªå¼€å§‹') }}</option>
                    <option value="è¿›è¡Œä¸­" {% if filter_status == 'è¿›è¡Œä¸­' %}selected{% endif %}>{{ _('è¿›è¡Œä¸­') }}</option>
                    <option value="å·²å®Œæˆ" {% if filter_status == 'å·²å®Œæˆ' %}selected{% endif %}>{{ _('å·²å®Œæˆ') }}</option>
                </select>
            </div>
            <div class="col-md-4">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary flex-grow-1">
                        <i class="bi bi-search"></i> {{ _('æœç´¢') }}
                    </button>
                    <a href="{{ url_for('precom.precom_task_list') }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-clockwise"></i> {{ _('é‡ç½®') }}
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th style="width: 80px;">{{ _('ä»»åŠ¡ID') }}</th>
                        <th style="width: 140px;">{{ _('ä»»åŠ¡ç±»å‹') }}</th>
                        <th style="width: 120px;">{{ _('ç³»ç»Ÿ') }}</th>
                        <th style="width: 140px;">{{ _('å­ç³»ç»Ÿ') }}</th>
                        <th style="width: 150px;">{{ _('å›¾çº¸å·') }}</th>
                        <th style="width: 150px;">Tag / {{ _('ç‚¹ä½') }}</th>
                        <th style="width: 120px;">{{ _('åŒºåŸŸ') }} Block</th>
                        <th style="width: 120px;" class="text-center">{{ _('æ•°é‡') }}</th>
                        <th style="width: 140px;">{{ _('è®¡åˆ’æ—¶é—´') }}</th>
                        <th style="width: 140px;">{{ _('å®é™…æ—¶é—´') }}</th>
                        <th style="width: 100px;">{{ _('çŠ¶æ€') }}</th>
                        <th style="width: 120px;">{{ _('æ“ä½œ') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% if tasks %}
                    {% for t in tasks %}
                    <tr>
                        <td>{{ t.TaskID }}</td>
                        <td>
                            {% if t.TaskType == 'Manhole' %}{{ _('äººå­”æ£€æŸ¥') }}
                            {% elif t.TaskType == 'MotorSolo' %}{{ _('ç”µæœºå•è¯•') }}
                            {% elif t.TaskType == 'SkidInstall' %}{{ _('ä»ªè¡¨å°ä»¶å®‰è£…') }}
                            {% elif t.TaskType == 'LoopTest' %}{{ _('å›è·¯æµ‹è¯•') }}
                            {% elif t.TaskType == 'Alignment' %}{{ _('åŠ¨è®¾å¤‡æœ€ç»ˆå¯¹ä¸­') }}
                            {% elif t.TaskType == 'MRT' %}{{ _('MRTæœºæ¢°è”åŠ¨æµ‹è¯•') }}
                            {% elif t.TaskType == 'FunctionTest' %}Function Test
                            {% else %}{{ t.TaskType }}
                            {% endif %}
                        </td>
                        <td>{{ t.SystemCode or '-' }}</td>
                        <td>{{ t.SubSystemCode }}</td>
                        <td>{{ t.DrawingNumber or '-' }}</td>
                        <td>
                            {% if t.PointTag %}
                                {{ t.TagNumber or '-' }} / {{ t.PointTag }}
                            {% else %}
                                {{ t.TagNumber or '-' }}
                            {% endif %}
                        </td>
                        <td>{{ t.PositionBlock or '-' }}</td>
                        <td class="text-center">
                            {{ t.QuantityDone }}/{{ t.QuantityTotal }}
                        </td>
                        <td>{{ t.PlannedDate or '-' }}</td>
                        <td>{{ t.ActualDate or '-' }}</td>
                        <td>
                            {% if t.Status == 'å·²å®Œæˆ' %}
                            <span class="badge bg-success">{{ _(t.Status) }}</span>
                            {% elif t.Status == 'è¿›è¡Œä¸­' %}
                            <span class="badge bg-warning text-dark">{{ _(t.Status) }}</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ _(t.Status) }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('precom.precom_task_edit', task_id=t.TaskID) }}"
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil"></i> {{ _('ç¼–è¾‘') }}
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="12" class="text-center text-muted py-4">
                            <i class="bi bi-inbox"></i> {{ _('æš‚æ— ä»»åŠ¡è®°å½•') }}
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // ç³»ç»Ÿä»£ç autocomplete
    var precomTaskSystemCodeInput = document.getElementById('precomTaskSystemCodeInput');
    var precomTaskSystemCodeAutocompleteList = document.getElementById('precomTaskSystemCodeAutocompleteList');
    var precomTaskSystemCodeTimer = null;
    
    if (precomTaskSystemCodeInput && precomTaskSystemCodeAutocompleteList) {
        // åˆå§‹åŒ–æ—¶åŠ è½½æ‰€æœ‰ç³»ç»Ÿ
        fetch('/api/systems/autocomplete?limit=100')
            .then(response => response.json())
            .then(data => {
                precomTaskSystemCodeAutocompleteList.innerHTML = '';
                data.forEach(function(item) {
                    var option = document.createElement('option');
                    option.value = item.code;
                    option.textContent = item.label;
                    precomTaskSystemCodeAutocompleteList.appendChild(option);
                });
            });
        
        precomTaskSystemCodeInput.addEventListener('input', function() {
            var query = this.value.trim();
            clearTimeout(precomTaskSystemCodeTimer);
            
            if (query.length < 1) {
                fetch('/api/systems/autocomplete?limit=100')
                    .then(response => response.json())
                    .then(data => {
                        precomTaskSystemCodeAutocompleteList.innerHTML = '';
                        data.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.code;
                            option.textContent = item.label;
                            precomTaskSystemCodeAutocompleteList.appendChild(option);
                        });
                    });
                return;
            }
            
            precomTaskSystemCodeTimer = setTimeout(function() {
                fetch('/api/systems/autocomplete?q=' + encodeURIComponent(query) + '&limit=20')
                    .then(response => response.json())
                    .then(data => {
                        precomTaskSystemCodeAutocompleteList.innerHTML = '';
                        data.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.code;
                            option.textContent = item.label;
                            precomTaskSystemCodeAutocompleteList.appendChild(option);
                        });
                    });
            }, 300);
        });
        
        // ç³»ç»Ÿä»£ç å˜åŒ–æ—¶ï¼ŒåŠ è½½å¯¹åº”çš„å­ç³»ç»Ÿ
        $(precomTaskSystemCodeInput).on('change', function() {
            var systemCode = this.value.trim();
            console.log('ğŸ”„ ç³»ç»Ÿå˜åŒ–:', systemCode);
            
            // æ¸…ç©ºå­ç³»ç»Ÿé€‰æ‹©
            var subsystemInput = document.getElementById('precomTaskSubsystemCodeInput');
            if (subsystemInput) {
                subsystemInput.value = '';
            }
            
            if (systemCode) {
                $.get("/api/subsystems/" + systemCode, function(data) {
                    var subsystemAutocompleteList = document.getElementById('precomTaskSubsystemCodeAutocompleteList');
                    if (subsystemAutocompleteList) {
                        subsystemAutocompleteList.innerHTML = '';
                        data.forEach(function(subsystem) {
                            var option = document.createElement('option');
                            option.value = subsystem.SubSystemCode;
                            option.textContent = subsystem.SubSystemCode + ' - ' + (subsystem.SubSystemDescriptionENG || '');
                            subsystemAutocompleteList.appendChild(option);
                        });
                    }
                    console.log('âœ… å­ç³»ç»Ÿé€‰é¡¹å·²æ›´æ–°');
                });
            } else {
                var subsystemAutocompleteList = document.getElementById('precomTaskSubsystemCodeAutocompleteList');
                if (subsystemAutocompleteList) {
                    subsystemAutocompleteList.innerHTML = '';
                }
            }
        });
    }
    
    // å­ç³»ç»Ÿä»£ç autocomplete
    var precomTaskSubsystemCodeInput = document.getElementById('precomTaskSubsystemCodeInput');
    var precomTaskSubsystemCodeAutocompleteList = document.getElementById('precomTaskSubsystemCodeAutocompleteList');
    var precomTaskSubsystemCodeTimer = null;
    
    if (precomTaskSubsystemCodeInput && precomTaskSubsystemCodeAutocompleteList) {
        // å¦‚æœæœ‰åˆå§‹ç³»ç»Ÿå€¼ï¼ŒåŠ è½½å¯¹åº”çš„å­ç³»ç»Ÿ
        var initialSystemCode = precomTaskSystemCodeInput ? precomTaskSystemCodeInput.value.trim() : '';
        if (initialSystemCode) {
            $.get("/api/subsystems/" + initialSystemCode, function(data) {
                precomTaskSubsystemCodeAutocompleteList.innerHTML = '';
                data.forEach(function(subsystem) {
                    var option = document.createElement('option');
                    option.value = subsystem.SubSystemCode;
                    option.textContent = subsystem.SubSystemCode + ' - ' + (subsystem.SubSystemDescriptionENG || '');
                    precomTaskSubsystemCodeAutocompleteList.appendChild(option);
                });
            });
        }
        
        precomTaskSubsystemCodeInput.addEventListener('input', function() {
            var query = this.value.trim();
            var systemCode = precomTaskSystemCodeInput ? precomTaskSystemCodeInput.value.trim() : '';
            clearTimeout(precomTaskSubsystemCodeTimer);
            
            if (query.length < 1) {
                if (systemCode) {
                    // å¦‚æœæœ‰ç³»ç»Ÿé€‰æ‹©ï¼Œæ˜¾ç¤ºè¯¥ç³»ç»Ÿçš„æ‰€æœ‰å­ç³»ç»Ÿ
                    $.get("/api/subsystems/" + systemCode, function(data) {
                        precomTaskSubsystemCodeAutocompleteList.innerHTML = '';
                        data.forEach(function(subsystem) {
                            var option = document.createElement('option');
                            option.value = subsystem.SubSystemCode;
                            option.textContent = subsystem.SubSystemCode + ' - ' + (subsystem.SubSystemDescriptionENG || '');
                            precomTaskSubsystemCodeAutocompleteList.appendChild(option);
                        });
                    });
                } else {
                    precomTaskSubsystemCodeAutocompleteList.innerHTML = '';
                }
                return;
            }
            
            precomTaskSubsystemCodeTimer = setTimeout(function() {
                var url = '/api/subsystems/autocomplete?q=' + encodeURIComponent(query) + '&limit=20';
                if (systemCode) {
                    url += '&system_code=' + encodeURIComponent(systemCode);
                }
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        precomTaskSubsystemCodeAutocompleteList.innerHTML = '';
                        data.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.code;
                            option.textContent = item.label;
                            precomTaskSubsystemCodeAutocompleteList.appendChild(option);
                        });
                    });
            }, 300);
        });
    }
});
</script>
{% endblock %}


