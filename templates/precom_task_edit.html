{% extends "base_industrial.html" %}

{% block title %}{{ _('预试车任务编辑') }} - {{ _('预试车管理系统') }}{% endblock %}

{% block content %}
<style>
    .task-form-section {
        border-bottom: 1px dashed #e2e8f0;
        padding-bottom: 1.25rem;
        margin-bottom: 1.75rem;
    }
    .task-form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    .task-section-title {
        font-weight: 700;
        color: var(--primary-blue, #1e3a8a);
        display: flex;
        align-items: center;
        gap: .5rem;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: .08em;
        font-size: .95rem;
    }
    .task-section-title i {
        color: var(--industrial-orange, #f97316);
    }
.task-attachments, .task-punch {
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
}
.form-label {
    text-transform: uppercase;
    font-size: .8rem;
    letter-spacing: .05em;
    color: var(--steel-gray, #475569);
}
.activity-progress-table {
    font-size: .78rem;
    table-layout: auto;
    border-collapse: collapse;
}
.activity-progress-table th,
.activity-progress-table td {
    white-space: nowrap;
    vertical-align: middle;
    padding: .2rem .3rem;
    border: none !important;
    background-color: transparent !important;
}
/* ActDescription列允许换行 */
.activity-progress-table td:nth-child(3) {
    white-space: normal;
    word-wrap: break-word;
}
/* 输入框样式 - 完全透明无底纹 */
.activity-progress-table input.form-control-sm,
.activity-progress-table textarea.form-control-sm {
    font-size: .78rem;
    padding: .15rem .35rem;
    border: none;
    background-color: transparent;
    border-radius: 0;
    transition: all 0.2s ease;
}
/* 获得焦点时的样式 */
.activity-progress-table input.form-control-sm:focus,
.activity-progress-table textarea.form-control-sm:focus {
    background-color: rgba(13, 110, 253, 0.05);
    border: none;
    border-bottom: 2px solid #0d6efd;
    box-shadow: none;
    outline: none;
}
/* ActDescription的textarea特殊样式 */
.activity-progress-table textarea.form-control-sm {
    resize: vertical;
    min-height: 2.2rem;
    line-height: 1.3;
    overflow-y: auto;
    scrollbar-width: none; /* Firefox隐藏滚动条 */
}
/* 完全隐藏滚动条 - Webkit浏览器 */
.activity-progress-table textarea.form-control-sm::-webkit-scrollbar {
    display: none;
}
/* 鼠标悬停时显示可编辑状态 */
.activity-progress-table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}
.activity-progress-table tbody tr:hover input,
.activity-progress-table tbody tr:hover textarea {
    background-color: rgba(255, 255, 255, 0.5);
}
/* 表头样式 - 高对比度 */
.activity-progress-table thead th {
    background-color: #f8f9fa !important;
    color: #2c3e50 !important;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6 !important;
}
</style>
<div class="page-header d-flex justify-content-between align-items-end">
    <div>
        <h1>
            <i class="bi bi-clipboard-check"></i>
            {% if task %}{{ _('编辑预试车任务') }}{% else %}{{ _('新建预试车任务') }}{% endif %}
        </h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/"><i class="bi bi-house-door"></i> {{ _('首页') }}</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('precom.precom_task_list') }}">{{ _('预试车任务管理') }}</a></li>
                <li class="breadcrumb-item active">{% if task %}{{ _('编辑') }}{% else %}{{ _('新建') }}{% endif %}</li>
            </ol>
        </nav>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('precom.precom_task_list', task_type=task.TaskType if task else task_type) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> {{ _('返回列表') }}
        </a>
        {% if task %}
        <form id="deleteTaskForm" method="post" action="{{ url_for('precom.precom_task_delete', task_id=task.TaskID) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="button" class="btn btn-outline-danger" id="deleteTaskBtn">
                <i class="bi bi-trash"></i> {{ _('删除任务') }}
            </button>
        </form>
        {% endif %}
    </div>
</div>

<div class="row g-4" {% if task %}data-task-id="{{ task.TaskID }}"{% endif %}>
    <div class="col-12">
        <div class="card card-industrial mb-0">
            <div class="card-header">
                <strong>{{ _('任务基本信息') }}</strong>
            </div>
            <div class="card-body">
                <form method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <!-- 施工进度模块 -->
                    <div class="task-form-section">
                        <div class="task-section-title">
                            <i class="bi bi-bar-chart-line"></i> {{ _('施工进度') }}
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle activity-progress-table table-borderless">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 150px;">ACT ID</th>
                                        <th style="width: 130px;">Block</th>
                                        <th style="width: 280px; min-width: 280px;">Act Description</th>
                                        <th style="width: 80px;">Scope</th>
                                        <th style="width: 90px;">Discipline</th>
                                        <th style="width: 110px;">Work Package</th>
                                        <th style="width: 95px;">Total Qty</th>
                                        <th style="width: 110px;">Completed Qty</th>
                                        <th style="width: 105px;">Completed %</th>
                                        <th style="width: 90px;">Weight</th>
                                        <th style="width: 95px;">Man Hours</th>
                                        <th style="width: 100px;">Subproject</th>
                                        <th style="width: 60px;" class="text-center">{{ _('操作') }}</th>
                                    </tr>
                                </thead>
                                <tbody id="activityTableBody">
                                    {% if activities %}
                                        {% for a in activities %}
                                        <tr>
                                            <td>
                                                <input type="text" class="form-control form-control-sm"
                                                       name="ActivityActID" value="{{ a.ActID or '' }}">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm"
                                                       name="ActivityBlock" list="ActivityBlockList"
                                                       value="{{ a.Block or '' }}">
                                            </td>
                                            <td>
                                                <textarea class="form-control form-control-sm" rows="1"
                                                          name="ActivityDescription">{{ a.ActDescription or '' }}</textarea>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm"
                                                       name="ActivityScope" value="{{ a.Scope or '' }}">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm"
                                                       name="ActivityDiscipline" value="{{ a.Discipline or '' }}">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm"
                                                       name="ActivityWorkPackage" value="{{ a.WorkPackage or '' }}">
                                            </td>
                                            <td>
                                                <input type="number" step="0.01" class="form-control form-control-sm"
                                                       name="ActivityTotalQuantity" value="{{ a.TotalQuantity or '' }}">
                                            </td>
                                            <td>
                                                <input type="number" step="0.01" class="form-control form-control-sm"
                                                       name="ActivityCompletedQuantity" value="{{ a.CompletedQuantity or '' }}">
                                            </td>
                                            <td>
                                                <input type="number" step="0.01" class="form-control form-control-sm"
                                                       name="ActivityCompletedPercent" value="{{ a.CompletedPercent or '' }}">
                                            </td>
                                            <td>
                                                <input type="number" step="0.01" class="form-control form-control-sm"
                                                       name="ActivityWeightFactor" value="{{ a.WeightFactor or '' }}">
                                            </td>
                                            <td>
                                                <input type="number" step="0.01" class="form-control form-control-sm"
                                                       name="ActivityManHours" value="{{ a.ManHours or '' }}">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm"
                                                       name="ActivitySubproject" value="{{ a.Subproject or '' }}">
                                            </td>
                                            <td class="text-center">
                                                <button type="button" class="btn btn-sm btn-outline-danger activity-remove-row">
                                                    -
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" name="ActivityActID">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm"
                                                       name="ActivityBlock" list="ActivityBlockList">
                                            </td>
                                            <td>
                                                <textarea class="form-control form-control-sm" rows="1" name="ActivityDescription"></textarea>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" name="ActivityScope">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" name="ActivityDiscipline">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" name="ActivityWorkPackage">
                                            </td>
                                            <td>
                                                <input type="number" step="0.01" class="form-control form-control-sm" name="ActivityTotalQuantity">
                                            </td>
                                            <td>
                                                <input type="number" step="0.01" class="form-control form-control-sm" name="ActivityCompletedQuantity">
                                            </td>
                                            <td>
                                                <input type="number" step="0.01" class="form-control form-control-sm" name="ActivityCompletedPercent">
                                            </td>
                                            <td>
                                                <input type="number" step="0.01" class="form-control form-control-sm" name="ActivityWeightFactor">
                                            </td>
                                            <td>
                                                <input type="number" step="0.01" class="form-control form-control-sm" name="ActivityManHours">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" name="ActivitySubproject">
                                            </td>
                                            <td class="text-center">
                                                <button type="button" class="btn btn-sm btn-outline-danger activity-remove-row">
                                                    -
                                                </button>
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        <datalist id="ActivityBlockList"></datalist>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="addActivityRowBtn">
                                <i class="bi bi-plus-circle"></i> {{ _('新增关键工程量') }}
                            </button>
                        </div>
                    </div>
                    <div class="task-form-section">
                        <div class="task-section-title">
                            <i class="bi bi-grid"></i> {{ _('基础属性') }}
                        </div>
                        <div class="row g-3">
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">{{ _('任务类型') }}</label>
                                <select class="form-select" name="TaskType" disabled>
                                    {% set current_type = task_type or (task.TaskType if task else 'Manhole') %}
                                    {% set types = [
                                        ('Manhole', '人孔检查'),
                                        ('MotorSolo', '电机单试'),
                                        ('SkidInstall', '仪表台件安装'),
                                        ('LoopTest', '回路测试'),
                                        ('Alignment', '动设备最终对中'),
                                        ('MRT', 'MRT机械联动测试'),
                                        ('FunctionTest', 'Function Test')
                                    ] %}
                                    {% for code, label in types %}
                                    <option value="{{ code }}" {% if current_type == code %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">{{ _('系统') }} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="SystemCode" id="SystemCode"
                                       list="SystemCodeList" required
                                       value="{{ task.SystemCode if task else '' }}"
                                       placeholder="可手填系统编码，支持下拉自动补齐">
                                <datalist id="SystemCodeList"></datalist>
                                <small class="text-muted" id="SystemDescriptionHint"></small>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">{{ _('子系统') }} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="SubSystemCode" id="SubSystemCode"
                                       list="SubSystemCodeList" required
                                       value="{{ task.SubSystemCode if task else '' }}"
                                       placeholder="可手填子系统编码，支持下拉自动补齐">
                                <datalist id="SubSystemCodeList"></datalist>
                                <small class="text-muted" id="SubSystemDescriptionHint"></small>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">区域 Block</label>
                                <div id="blockRows">
                                    {% for b in block_rows %}
                                    <div class="input-group block-row mb-2">
                                        <input type="text" class="form-control" name="PositionBlocks"
                                               list="BlockOptions" value="{{ b }}">
                                        <button type="button" class="btn btn-outline-danger block-remove-row">-</button>
                                    </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-1" id="addBlockRowBtn">
                                    <i class="bi bi-plus-circle"></i> 新增 Block
                                </button>
                                <small class="text-muted d-block mt-1">从 Faclist.Block 选择或手动输入，可添加多行。</small>
                                <datalist id="BlockOptions"></datalist>
                            </div>
                        </div>
                    </div>

                    <div class="task-form-section">
                        <div class="task-section-title">
                            <i class="bi bi-geo-alt"></i> {{ _('识别信息') }}
                        </div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">图纸号 / Vendor Print</label>
                                <div id="drawingRows">
                                    {% for d in drawing_rows %}
                                    <div class="input-group drawing-row mb-2">
                                        <input type="text" class="form-control" name="DrawingNumbers"
                                               value="{{ d }}" placeholder="请输入图纸号">
                                        <button type="button" class="btn btn-outline-danger drawing-remove-row">-</button>
                                    </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-1" id="addDrawingRowBtn">
                                    <i class="bi bi-plus-circle"></i> {{ _('新增图纸号') }}
                                </button>
                                <small class="text-muted d-block mt-1">每行一条图纸号，可根据需要添加多条。</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">TagNumber / 设备位号</label>
                                <input type="text" class="form-control" name="TagNumber"
                                       value="{{ task.TagNumber if task else '' }}">
                            </div>
                            {% set current_type = task.TaskType if task else task_type %}
                            {% if current_type == 'LoopTest' %}
                            <div class="col-md-4">
                                <label class="form-label fw-bold">仪表点位 / PointTag（仅回路测试）</label>
                                <input type="text" class="form-control" name="PointTag"
                                       value="{{ task.PointTag if task else '' }}" placeholder="仅 LoopTest 需要填写">
                            </div>
                            {% endif %}
                            <div class="col-12">
                                <label class="form-label fw-bold">{{ _('任务描述') }}</label>
                                <input type="text" class="form-control" name="Description"
                                       value="{{ task.Description if task else '' }}">
                            </div>
                        </div>
                    </div>

                    <div class="task-form-section">
                        <div class="task-section-title">
                            <i class="bi bi-collection"></i> {{ _('测试参数') }}
                        </div>
                        <div class="row g-3">
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">{{ _('测试类型') }}</label>
                                <input type="text" class="form-control" name="TestType"
                                       value="{{ task.TestType if task else '' }}" placeholder="可选">
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">{{ _('总数量') }}</label>
                                <input type="number" min="0" class="form-control" name="QuantityTotal"
                                       value="{{ task.QuantityTotal if task else 1 }}">
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">{{ _('已完成数量') }}</label>
                                <input type="number" min="0" class="form-control" name="QuantityDone"
                                       value="{{ task.QuantityDone if task else 0 }}">
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">Performed by</label>
                                <input type="text" class="form-control" name="PerformedBy"
                                       value="{{ task.PerformedBy if task else '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">{{ _('测试计划时间') }}</label>
                                <input type="datetime-local" class="form-control" name="PlannedDate"
                                       value="{{ task.PlannedDate|replace(' ', 'T') if task and task.PlannedDate }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">{{ _('测试实际时间') }}</label>
                                <input type="datetime-local" class="form-control" name="ActualDate"
                                       value="{{ task.ActualDate|replace(' ', 'T') if task and task.ActualDate }}">
                            </div>
                        </div>
                    </div>

                    <div class="mt-3 d-flex justify-content-end gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> {{ _('保存') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if task %}
    <div class="col-12">
        <div class="card card-industrial task-attachments">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>{{ _('测试资料附件') }}</strong>
                <a href="{{ url_for('precom.precom_export_single_task', task_id=task.TaskID) }}" class="btn btn-sm btn-outline-success">
                    <i class="bi bi-download"></i> {{ _('导出') }}
                </a>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">{{ _('上传附件') }}</label>
                    <div class="row g-2">
                        <div class="col-md-8 col-sm-12">
                            <input type="file" id="attachmentFiles" multiple class="form-control">
                        </div>
                        <div class="col-md-4 col-sm-12 d-grid">
                            <button class="btn btn-outline-primary" id="uploadAttachmentBtn">
                                <i class="bi bi-upload"></i> {{ _('上传附件') }}
                            </button>
                        </div>
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 360px; overflow-y: auto;">
                    <table class="table table-sm align-middle table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>{{ _('文件名') }}</th>
                                <th class="text-end" style="width: 80px;">{{ _('操作') }}</th>
                            </tr>
                        </thead>
                        <tbody id="attachmentTableBody">
                            {% if attachments %}
                            {% for a in attachments %}
                            <tr data-attachment-id="{{ a.AttachmentID }}">
                                <td><small>{{ a.FileName }}</small></td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-danger" data-action="delete-attachment" title="删除">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="2" class="text-center text-muted py-3">{{ _('暂无附件') }}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12">
        <div class="card card-industrial task-punch">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Punch List / 尾项</strong>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('precom.precom_punch_template', task_id=task.TaskID) }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-download"></i> {{ _('模板') }}
                    </a>
                    <form id="punchImportForm" method="post" enctype="multipart/form-data"
                          action="{{ url_for('precom.precom_import_punch', task_id=task.TaskID) }}" class="mb-0">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <label class="btn btn-sm btn-outline-primary mb-0">
                            <i class="bi bi-upload"></i> {{ _('导入') }}
                            <input type="file" name="file" accept=".xlsx,.xls" style="display:none" onchange="this.form.submit();">
                        </label>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-2 mb-3">
                    <div class="col-md-3 col-sm-6">
                        <input type="text" class="form-control form-control-sm" id="punchNoInput" placeholder="PUNCH NO.">
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <input type="text" class="form-control form-control-sm" id="refNoInput" placeholder="ISO / TAG">
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <input type="text" class="form-control form-control-sm" id="sheetNoInput" placeholder="SHEET NO.">
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <input type="text" class="form-control form-control-sm" id="revNoInput" placeholder="REV NO.">
                    </div>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" id="punchDescInput" placeholder="{{ _('描述（必填）') }}">
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <select class="form-select form-select-sm" id="punchCategoryInput">
                            <option value="">{{ _('-- 选择 CATEGORY --') }}</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <select class="form-select form-select-sm" id="punchCauseInput">
                            <option value="">{{ _('-- 选择 CAUSE --') }}</option>
                            <option value="N">N - Non-Conformity</option>
                            <option value="F">F - Field Revion</option>
                            <option value="E">E - Re-Engineering</option>
                        </select>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <input type="text" class="form-control form-control-sm" id="punchIssuedInput" placeholder="ISSUED BY">
                    </div>
                    <div class="col-md-3 col-sm-6 d-flex align-items-center">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="rectifiedInput">
                            <label class="form-check-label" for="rectifiedInput">RECTIFIED</label>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 d-flex align-items-center">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="verifiedInput">
                            <label class="form-check-label" for="verifiedInput">VERIFIED</label>
                        </div>
                    </div>
                </div>
                <button class="btn btn-outline-primary mb-3" id="addPunchBtn">
                    <i class="bi bi-plus-circle"></i> {{ _('新增尾项') }}
                </button>
                <div class="table-responsive" style="max-height: 360px; overflow-y: auto;">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Punch No.</th>
                                <th>ISO / Tag</th>
                                <th>Sheet</th>
                                <th>Rev</th>
                                <th>{{ _('描述') }}</th>
                                <th>Category</th>
                                <th>Cause</th>
                                <th>Issued By</th>
                                <th>{{ _('提出日期') }}</th>
                                <th>Rectified</th>
                                <th>Verified</th>
                                <th>Deleted</th>
                                <th class="text-end">操作</th>
                            </tr>
                        </thead>
                        <tbody id="punchTableBody">
                            {% if punches %}
                            {% for p in punches %}
                            <tr data-id="{{ p.ID }}">
                                <td><small>{{ p.PunchNo or '-' }}</small></td>
                                <td><small>{{ p.RefNo or '-' }}</small></td>
                                <td><small>{{ p.SheetNo or '-' }}</small></td>
                                <td><small>{{ p.RevNo or '-' }}</small></td>
                                <td><small>{{ p.Description }}</small></td>
                                <td><small>{{ p.Category or '-' }}</small></td>
                                <td><small>{{ p.Cause or '-' }}</small></td>
                                <td><small>{{ p.IssuedBy or '-' }}</small></td>
                                <td><small>{{ p.CreatedAt or '-' }}</small></td>
                                <td>
                                    {% if p.Rectified == 'Y' %}
                                    <span class="badge bg-success">是</span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">否</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if p.Verified == 'Y' %}
                                    <span class="badge bg-success">是</span>
                                    {% else %}
                                    <span class="badge bg-secondary">否</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if p.Deleted == 'Y' %}
                                    <span class="badge bg-danger">已删除</span>
                                    {% else %}
                                    <span class="badge bg-secondary">否</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-danger" data-action="delete-punch" title="删除">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="12" class="text-center text-muted py-3">暂无尾项</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
(function () {
    const taskIdEl = document.querySelector('.row.g-4[data-task-id]');
    const taskId = taskIdEl && taskIdEl.dataset.taskId ? parseInt(taskIdEl.dataset.taskId) : null;

    // 系统/子系统描述提示与级联（使用动态API）
    let currentSubsystems = [];
    const systemInput = document.getElementById('SystemCode');
    const systemDescHint = document.getElementById('SystemDescriptionHint');
    const systemCodeList = document.getElementById('SystemCodeList');
    const subsystemInput = document.getElementById('SubSystemCode');
    const subsystemDescHint = document.getElementById('SubSystemDescriptionHint');
    const subsystemCodeList = document.getElementById('SubSystemCodeList');
    
    var systemCodeTimer = null;
    var subsystemCodeTimer = null;

    // 系统代码autocomplete
    if (systemInput && systemCodeList) {
        // 初始化时加载所有系统
        fetch('/api/systems/autocomplete?limit=100')
            .then(response => response.json())
            .then(data => {
                systemCodeList.innerHTML = '';
                data.forEach(function(item) {
                    var option = document.createElement('option');
                    option.value = item.code;
                    option.textContent = item.label;
                    systemCodeList.appendChild(option);
                });
                
                // 如果有初始值，查找并显示描述
                if (systemInput.value) {
                    const sys = data.find(s => s.code === systemInput.value.trim());
                    if (sys && systemDescHint) {
                        systemDescHint.textContent = sys.label.split(' - ')[1] || '';
                    }
                    loadSubsystemsForSystem(systemInput.value.trim());
                }
            });
        
        systemInput.addEventListener('input', function() {
            var query = this.value.trim();
            clearTimeout(systemCodeTimer);
            
            if (query.length < 1) {
                fetch('/api/systems/autocomplete?limit=100')
                    .then(response => response.json())
                    .then(data => {
                        systemCodeList.innerHTML = '';
                        data.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.code;
                            option.textContent = item.label;
                            systemCodeList.appendChild(option);
                        });
                    });
                return;
            }
            
            systemCodeTimer = setTimeout(function() {
                fetch('/api/systems/autocomplete?q=' + encodeURIComponent(query) + '&limit=20')
                    .then(response => response.json())
                    .then(data => {
                        systemCodeList.innerHTML = '';
                        data.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.code;
                            option.textContent = item.label;
                            systemCodeList.appendChild(option);
                        });
                    });
            }, 300);
        });
        
        systemInput.addEventListener('change', function () {
            const code = this.value.trim();
            if (code && systemDescHint) {
                // 从datalist中查找描述
                const options = systemCodeList.querySelectorAll('option');
                for (let opt of options) {
                    if (opt.value === code) {
                        const parts = opt.textContent.split(' - ');
                        systemDescHint.textContent = parts.length > 1 ? parts[1] : '';
                        break;
                    }
                }
            }
            loadSubsystemsForSystem(code);
        });
    }

    function refreshSubsystemDatalist(list) {
        if (!subsystemCodeList) return;
        subsystemCodeList.innerHTML = '';
        (list || []).forEach(sub => {
            const opt = document.createElement('option');
            opt.value = sub.SubSystemCode;
            opt.textContent = `${sub.SubSystemCode} - ${sub.SubSystemDescriptionENG || ''}`;
            subsystemCodeList.appendChild(opt);
        });
    }

    function loadSubsystemsForSystem(systemCode) {
        if (!systemCode) {
            currentSubsystems = [];
            refreshSubsystemDatalist(currentSubsystems);
            if (subsystemDescHint) subsystemDescHint.textContent = '';
            if (subsystemInput) subsystemInput.value = '';
            return;
        }
        fetch('/api/subsystems/' + encodeURIComponent(systemCode))
            .then(res => res.json())
            .then(data => {
                currentSubsystems = data || [];
                refreshSubsystemDatalist(currentSubsystems);
                const sub = currentSubsystems.find(s => s.SubSystemCode === (subsystemInput?.value || '').trim());
                if (sub && subsystemDescHint) {
                    subsystemDescHint.textContent = sub.SubSystemDescriptionENG || '';
                }
            })
            .catch(() => {
                console.error('加载子系统失败');
            });
    }

    // 子系统代码autocomplete
    if (subsystemInput && subsystemCodeList) {
        subsystemInput.addEventListener('input', function() {
            var query = this.value.trim();
            var systemCode = systemInput ? systemInput.value.trim() : '';
            clearTimeout(subsystemCodeTimer);
            
            if (query.length < 1 && !systemCode) {
                subsystemCodeList.innerHTML = '';
                return;
            }
            
            subsystemCodeTimer = setTimeout(function() {
                var url = '/api/subsystems/autocomplete?limit=20';
                if (query) {
                    url += '&q=' + encodeURIComponent(query);
                }
                if (systemCode) {
                    url += '&system_code=' + encodeURIComponent(systemCode);
                }
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        subsystemCodeList.innerHTML = '';
                        data.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.code;
                            option.textContent = item.label;
                            subsystemCodeList.appendChild(option);
                        });
                    });
            }, 300);
        });
        
        subsystemInput.addEventListener('change', function () {
            const code = this.value.trim();
            const sub = currentSubsystems.find(s => s.SubSystemCode === code);
            if (sub && subsystemDescHint) {
                subsystemDescHint.textContent = sub.SubSystemDescriptionENG || '';
            } else if (subsystemDescHint) {
                subsystemDescHint.textContent = '';
            }
        });

        // 初始描述填充
        if (subsystemInput.value) {
            const sub = currentSubsystems.find(s => s.SubSystemCode === subsystemInput.value.trim());
            if (sub && subsystemDescHint) {
                subsystemDescHint.textContent = sub.SubSystemDescriptionENG || '';
            }
        }
    }

    // Block 多行输入（+/-）
    const blockRowsContainer = document.getElementById('blockRows');
    const addBlockRowBtn = document.getElementById('addBlockRowBtn');
    const blockOptionsList = document.getElementById('BlockOptions');

    function bindBlockRowButtons() {
        if (!blockRowsContainer) return;
        blockRowsContainer.querySelectorAll('.block-remove-row').forEach(btn => {
            btn.onclick = function () {
                const row = this.closest('.block-row');
                if (!row) return;
                const totalRows = blockRowsContainer.querySelectorAll('.block-row').length;
                if (totalRows <= 1) {
                    row.querySelectorAll('input').forEach(inp => inp.value = '');
                } else {
                    row.remove();
                }
            };
        });
    }

    function addBlockRow(value = '') {
        if (!blockRowsContainer) return;
        const div = document.createElement('div');
        div.className = 'input-group block-row mb-2';
        div.innerHTML = `
            <input type="text" class="form-control" name="PositionBlocks" list="BlockOptions" value="${value}">
            <button type="button" class="btn btn-outline-danger block-remove-row">-</button>
        `;
        blockRowsContainer.appendChild(div);
        bindBlockRowButtons();
    }

    if (blockRowsContainer && blockRowsContainer.children.length === 0) {
        addBlockRow();
    }

    if (addBlockRowBtn) {
        addBlockRowBtn.addEventListener('click', () => addBlockRow());
    }

    function initBlockOptions() {
        fetch('/api/faclist/blocks')
            .then(res => res.json())
            .then(blocks => {
                if (blockOptionsList) {
                    blockOptionsList.innerHTML = '';
                }
                const activityBlockList = document.getElementById('ActivityBlockList');
                if (activityBlockList) {
                    activityBlockList.innerHTML = '';
                }
                (blocks || []).forEach(b => {
                    const label = String(b);
                    if (blockOptionsList) {
                        const opt = document.createElement('option');
                        opt.value = label;
                        blockOptionsList.appendChild(opt);
                    }
                    if (activityBlockList) {
                        const opt2 = document.createElement('option');
                        opt2.value = label;
                        activityBlockList.appendChild(opt2);
                    }
                });
            });
    }

    initBlockOptions();
    bindBlockRowButtons();

    // 图纸号多行输入（+/-）
    const drawingRowsContainer = document.getElementById('drawingRows');
    const addDrawingRowBtn = document.getElementById('addDrawingRowBtn');

    function bindDrawingRowButtons() {
        if (!drawingRowsContainer) return;
        drawingRowsContainer.querySelectorAll('.drawing-remove-row').forEach(btn => {
            btn.onclick = function () {
                const row = this.closest('.drawing-row');
                if (!row) return;
                const totalRows = drawingRowsContainer.querySelectorAll('.drawing-row').length;
                if (totalRows <= 1) {
                    row.querySelectorAll('input').forEach(inp => inp.value = '');
                } else {
                    row.remove();
                }
            };
        });
    }

    function addDrawingRow(value = '') {
        if (!drawingRowsContainer) return;
        const div = document.createElement('div');
        div.className = 'input-group drawing-row mb-2';
        div.innerHTML = `
            <input type="text" class="form-control" name="DrawingNumbers" value="${value}">
            <button type="button" class="btn btn-outline-danger drawing-remove-row">-</button>
        `;
        drawingRowsContainer.appendChild(div);
        bindDrawingRowButtons();
    }

    if (drawingRowsContainer && drawingRowsContainer.children.length === 0) {
        addDrawingRow();
    }
    if (addDrawingRowBtn) {
        addDrawingRowBtn.addEventListener('click', () => addDrawingRow());
    }
    bindDrawingRowButtons();

    // 关键工程量明细行：新增 / 删除
    const activityTableBody = document.getElementById('activityTableBody');
    const addActivityRowBtn = document.getElementById('addActivityRowBtn');

    function bindActivityRemoveButtons() {
        if (!activityTableBody) return;
        activityTableBody.querySelectorAll('.activity-remove-row').forEach(btn => {
            btn.onclick = function () {
                const tr = this.closest('tr');
                if (!tr) return;
                const totalRows = activityTableBody.querySelectorAll('tr').length;
                if (totalRows <= 1) {
                    // 保留至少一行，清空而不是删除
                    tr.querySelectorAll('input').forEach(inp => inp.value = '');
                } else {
                    tr.remove();
                }
            };
        });
    }

    function addEmptyActivityRow() {
        if (!activityTableBody) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm" name="ActivityActID"></td>
            <td><input type="text" class="form-control form-control-sm" name="ActivityBlock" list="ActivityBlockList"></td>
            <td><textarea class="form-control form-control-sm" rows="1" name="ActivityDescription"></textarea></td>
            <td><input type="text" class="form-control form-control-sm" name="ActivityScope"></td>
            <td><input type="text" class="form-control form-control-sm" name="ActivityDiscipline"></td>
            <td><input type="text" class="form-control form-control-sm" name="ActivityWorkPackage"></td>
            <td><input type="number" step="0.01" class="form-control form-control-sm" name="ActivityTotalQuantity"></td>
            <td><input type="number" step="0.01" class="form-control form-control-sm" name="ActivityCompletedQuantity"></td>
            <td><input type="number" step="0.01" class="form-control form-control-sm" name="ActivityCompletedPercent"></td>
            <td><input type="number" step="0.01" class="form-control form-control-sm" name="ActivityWeightFactor"></td>
            <td><input type="number" step="0.01" class="form-control form-control-sm" name="ActivityManHours"></td>
            <td><input type="text" class="form-control form-control-sm" name="ActivitySubproject"></td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger activity-remove-row">-</button>
            </td>
        `;
        activityTableBody.appendChild(tr);
        bindActivityRemoveButtons();
        return tr;
    }

    if (addActivityRowBtn) {
        addActivityRowBtn.addEventListener('click', addEmptyActivityRow);
    }
    bindActivityRemoveButtons();

    const activityFieldsOrder = [
        'ActivityActID',
        'ActivityBlock',
        'ActivityDescription',
        'ActivityScope',
        'ActivityDiscipline',
        'ActivityWorkPackage',
        'ActivityTotalQuantity',
        'ActivityCompletedQuantity',
        'ActivityCompletedPercent',
        'ActivityWeightFactor',
        'ActivityManHours',
        'ActivitySubproject'
    ];

    function ensureActivityRowCount(minCount) {
        if (!activityTableBody) return;
        while (activityTableBody.querySelectorAll('tr').length < minCount) {
            addEmptyActivityRow();
        }
    }

    if (activityTableBody) {
        activityTableBody.addEventListener('paste', function (event) {
            const target = event.target;
            if (!(target instanceof HTMLInputElement)) {
                return;
            }
            const fieldName = target.name;
            const startCol = activityFieldsOrder.indexOf(fieldName);
            if (startCol === -1) {
                return;
            }
            const clipboard = event.clipboardData || window.clipboardData;
            if (!clipboard) {
                return;
            }
            const text = clipboard.getData('text');
            if (!text || (!text.includes('\t') && !text.includes('\n'))) {
                return;
            }
            event.preventDefault();
            const rows = text
                .replace(/\r/g, '\n')
                .split('\n')
                .map(row => row.trimEnd())
                .filter(row => row.length);
            if (!rows.length) {
                return;
            }

            const tr = target.closest('tr');
            if (!tr) {
                return;
            }
            const allRows = Array.from(activityTableBody.querySelectorAll('tr'));
            const startRowIndex = allRows.indexOf(tr);
            if (startRowIndex === -1) {
                return;
            }

            rows.forEach((rowText, rowOffset) => {
                const values = rowText.split('\t');
                const rowIndex = startRowIndex + rowOffset;
                ensureActivityRowCount(rowIndex + 1);
                const targetRow = activityTableBody.querySelectorAll('tr')[rowIndex];
                values.forEach((cellValue, colOffset) => {
                    const fieldIndex = startCol + colOffset;
                    if (fieldIndex >= activityFieldsOrder.length) {
                        return;
                    }
                    const targetField = activityFieldsOrder[fieldIndex];
                    const input = targetRow.querySelector(`input[name="${targetField}"]`);
                    if (input) {
                        input.value = cellValue.trim();
                    }
                });
            });
        });
    }

    if (!taskId) {
        // 新建任务时，不需要附件和 Punch 的加载与删除逻辑
        return;
    }

    // 删除任务
    const deleteForm = document.getElementById('deleteTaskForm');
    const deleteBtn = document.getElementById('deleteTaskBtn');
    if (deleteForm && deleteBtn) {
        deleteBtn.addEventListener('click', function () {
            if (!confirm('确认删除该任务？该任务的附件和尾项也会一并删除。')) {
                return;
            }
            fetch(deleteForm.action, {
                method: 'POST'
            }).then(res => res.json())
              .then(data => {
                  if (!data.success) {
                      alert(data.error || '删除失败');
                  } else {
                      window.location.href = '{{ url_for("precom.precom_task_list") }}';
                  }
              })
              .catch(err => alert('删除失败：' + err));
        });
    }

    // 上传附件
    const uploadBtn = document.getElementById('uploadAttachmentBtn');
    const fileInput = document.getElementById('attachmentFiles');
    const attachmentBody = document.getElementById('attachmentTableBody');

    function reloadAttachments() {
        fetch(`/api/precom/tasks/${taskId}/attachments`)
            .then(res => res.json())
            .then(rows => {
                if (!rows.length) {
                    attachmentBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted py-3">暂无附件</td></tr>';
                    return;
                }
                attachmentBody.innerHTML = rows.map(a => `
                    <tr data-attachment-id="${a.AttachmentID}">
                        <td><small>${a.FileName}</small></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-danger" data-action="delete-attachment" title="删除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            })
            .catch(() => {
                attachmentBody.innerHTML = '<tr><td colspan="2" class="text-center text-danger py-3">附件加载失败</td></tr>';
            });
    }

    if (uploadBtn && fileInput) {
        uploadBtn.addEventListener('click', function () {
            if (!fileInput.files.length) {
                alert('请先选择需要上传的文件。');
                return;
            }
            const formData = new FormData();
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append('files', fileInput.files[i]);
            }
            uploadBtn.disabled = true;
            fetch(`/api/precom/tasks/${taskId}/attachments`, {
                method: 'POST',
                body: formData
            }).then(res => res.json())
              .then(data => {
                  if (!data.success) {
                      alert(data.error || '上传失败');
                  } else {
                      reloadAttachments();
                      fileInput.value = '';
                  }
              })
              .catch(err => {
                  alert('上传失败：' + err);
              })
              .finally(() => {
                  uploadBtn.disabled = false;
              });
        });
    }

    // 删除附件
    if (attachmentBody) {
        attachmentBody.addEventListener('click', function (e) {
            const btn = e.target.closest('[data-action="delete-attachment"]');
            if (!btn) return;
            const tr = btn.closest('tr');
            const attachmentId = tr && tr.getAttribute('data-attachment-id');
            if (!attachmentId) return;
            if (!confirm('确认删除该附件？')) return;
            fetch(`/api/precom/tasks/${taskId}/attachments/${attachmentId}`, {
                method: 'DELETE'
            }).then(res => res.json())
              .then(data => {
                  if (!data.success) {
                      alert(data.error || '删除失败');
                  } else {
                      reloadAttachments();
                  }
              })
              .catch(err => {
                  alert('删除失败：' + err);
              });
        });
    }

    // Punch 列表
    const punchBody = document.getElementById('punchTableBody');
    const addPunchBtn = document.getElementById('addPunchBtn');
    const punchNoInput = document.getElementById('punchNoInput');
    const refNoInput = document.getElementById('refNoInput');
    const sheetNoInput = document.getElementById('sheetNoInput');
    const revNoInput = document.getElementById('revNoInput');
    const punchDescInput = document.getElementById('punchDescInput');
    const punchCategoryInput = document.getElementById('punchCategoryInput');
    const punchCauseInput = document.getElementById('punchCauseInput');
    const punchIssuedInput = document.getElementById('punchIssuedInput');
    const rectifiedInput = document.getElementById('rectifiedInput');
    const verifiedInput = document.getElementById('verifiedInput');

    function reloadPunchList() {
        fetch(`/api/precom/tasks/${taskId}/punch_list`)
            .then(res => res.json())
            .then(rows => {
                if (!rows.length) {
                    punchBody.innerHTML = '<tr><td colspan="13" class="text-center text-muted py-3">暂无尾项</td></tr>';
                    return;
                }
                punchBody.innerHTML = rows.map(p => `
                    <tr data-id="${p.ID}">
                        <td><small>${p.PunchNo || '-'}</small></td>
                        <td><small>${p.RefNo || '-'}</small></td>
                        <td><small>${p.SheetNo || '-'}</small></td>
                        <td><small>${p.RevNo || '-'}</small></td>
                        <td><small>${p.Description || ''}</small></td>
                        <td><small>${p.Category || '-'}</small></td>
                        <td><small>${p.Cause || '-'}</small></td>
                        <td><small>${p.IssuedBy || '-'}</small></td>
                        <td><small>${p.CreatedAt || '-'}</small></td>
                        <td>
                            ${p.Rectified === 'Y'
                                ? '<span class="badge bg-success">是</span>'
                                : '<span class="badge bg-warning text-dark">否</span>'}
                        </td>
                        <td>
                            ${p.Verified === 'Y'
                                ? '<span class="badge bg-success">是</span>'
                                : '<span class="badge bg-secondary">否</span>'}
                        </td>
                        <td>
                            ${p.Deleted === 'Y'
                                ? '<span class="badge bg-danger">已删除</span>'
                                : '<span class="badge bg-secondary">否</span>'}
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-danger" data-action="delete-punch" title="删除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            })
            .catch(() => {
                punchBody.innerHTML = '<tr><td colspan="13" class="text-center text-danger py-3">尾项加载失败</td></tr>';
            });
    }

    if (addPunchBtn) {
        addPunchBtn.addEventListener('click', function () {
            const desc = (punchDescInput.value || '').trim();
            if (!desc) {
                alert('尾项描述为必填项。');
                return;
            }
            const payload = {
                PunchNo: punchNoInput.value || null,
                RefNo: refNoInput.value || null,
                SheetNo: sheetNoInput.value || null,
                RevNo: revNoInput.value || null,
                Description: desc,
                Category: punchCategoryInput.value || null,
                Cause: punchCauseInput.value || null,
                IssuedBy: punchIssuedInput.value || null,
                Rectified: rectifiedInput.checked ? 'Y' : 'N',
                Verified: verifiedInput.checked ? 'Y' : 'N'
            };
            addPunchBtn.disabled = true;
            fetch(`/api/precom/tasks/${taskId}/punch_list`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(res => res.json())
              .then(data => {
                  if (!data.success) {
                      alert(data.error || '保存失败');
                  } else {
                      punchNoInput.value = '';
                      refNoInput.value = '';
                      sheetNoInput.value = '';
                      revNoInput.value = '';
                      punchDescInput.value = '';
                      punchCategoryInput.value = '';
                      punchCauseInput.value = '';
                      punchIssuedInput.value = '';
                      rectifiedInput.checked = false;
                      verifiedInput.checked = false;
                      reloadPunchList();
                  }
              })
              .catch(err => {
                  alert('保存失败：' + err);
              })
              .finally(() => {
                  addPunchBtn.disabled = false;
              });
        });
    }

    if (punchBody) {
        punchBody.addEventListener('click', function (e) {
            const btn = e.target.closest('[data-action="delete-punch"]');
            if (!btn) return;
            const tr = btn.closest('tr');
            const id = tr && tr.getAttribute('data-id');
            if (!id) return;
            if (!confirm('确认删除该尾项？')) return;
            fetch(`/api/precom/tasks/${taskId}/punch_list/${id}`, {
                method: 'DELETE'
            }).then(res => res.json())
              .then(data => {
                  if (!data.success) {
                      alert(data.error || '删除失败');
                  } else {
                      reloadPunchList();
                  }
              })
              .catch(err => {
                  alert('删除失败：' + err);
              });
        });
    }
})();
</script>
{% endblock %}


