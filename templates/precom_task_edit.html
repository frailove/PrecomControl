{% extends "base_industrial.html" %}

{% block title %}预试车任务编辑 - 预试车管理系统{% endblock %}

{% block content %}
<style>
    .task-form-section {
        border-bottom: 1px dashed #e2e8f0;
        padding-bottom: 1.25rem;
        margin-bottom: 1.75rem;
    }
    .task-form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    .task-section-title {
        font-weight: 700;
        color: var(--primary-blue, #1e3a8a);
        display: flex;
        align-items: center;
        gap: .5rem;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: .08em;
        font-size: .95rem;
    }
    .task-section-title i {
        color: var(--industrial-orange, #f97316);
    }
    .task-attachments, .task-punch {
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }
    .form-label {
        text-transform: uppercase;
        font-size: .8rem;
        letter-spacing: .05em;
        color: var(--steel-gray, #475569);
    }
</style>
<div class="page-header d-flex justify-content-between align-items-end">
    <div>
        <h1>
            <i class="bi bi-clipboard-check"></i>
            {% if task %}编辑预试车任务{% else %}新建预试车任务{% endif %}
        </h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/"><i class="bi bi-house-door"></i> 首页</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('precom.precom_task_list') }}">预试车任务管理</a></li>
                <li class="breadcrumb-item active">{% if task %}编辑{% else %}新建{% endif %}</li>
            </ol>
        </nav>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('precom.precom_task_list', task_type=task.TaskType if task else task_type) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> 返回列表
        </a>
        {% if task %}
        <form id="deleteTaskForm" method="post" action="{{ url_for('precom.precom_task_delete', task_id=task.TaskID) }}">
            <button type="button" class="btn btn-outline-danger" id="deleteTaskBtn">
                <i class="bi bi-trash"></i> 删除任务
            </button>
        </form>
        {% endif %}
    </div>
</div>

<div class="row g-4">
    <div class="col-12">
        <div class="card card-industrial mb-0">
            <div class="card-header">
                <strong>任务基本信息</strong>
            </div>
            <div class="card-body">
                <form method="post">
                    <div class="task-form-section">
                        <div class="task-section-title">
                            <i class="bi bi-grid"></i> 基础属性
                        </div>
                        <div class="row g-3">
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">任务类型</label>
                                <select class="form-select" name="TaskType" disabled>
                                    {% set current_type = task_type or (task.TaskType if task else 'Manhole') %}
                                    {% set types = [
                                        ('Manhole', '人孔检查'),
                                        ('MotorSolo', '电机单试'),
                                        ('SkidInstall', '仪表台件安装'),
                                        ('LoopTest', '回路测试'),
                                        ('Alignment', '动设备最终对中'),
                                        ('MRT', 'MRT机械联动测试'),
                                        ('FunctionTest', 'Function Test')
                                    ] %}
                                    {% for code, label in types %}
                                    <option value="{{ code }}" {% if current_type == code %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">系统 <span class="text-danger">*</span></label>
                                <select class="form-select" name="SystemCode" id="SystemCode" required>
                                    <option value="">请选择系统</option>
                                    {% for system in systems %}
                                    {% set selected = (task.SystemCode if task else None) %}
                                    <option value="{{ system.SystemCode }}" {% if system.SystemCode == selected %}selected{% endif %}>
                                        {{ system.SystemCode }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">子系统 <span class="text-danger">*</span></label>
                                <select class="form-select" name="SubSystemCode" id="SubSystemCode" required>
                                    <option value="">请选择子系统</option>
                                    {% for subsystem in subsystems %}
                                    {% set selected_sub = (task.SubSystemCode if task else None) %}
                                    <option value="{{ subsystem.SubSystemCode }}" {% if subsystem.SubSystemCode == selected_sub %}selected{% endif %}>
                                        {{ subsystem.SubSystemCode }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">区域 Block</label>
                                <input type="text" class="form-control" name="PositionBlock"
                                       value="{{ task.PositionBlock if task else '' }}">
                            </div>
                        </div>
                    </div>

                    <div class="task-form-section">
                        <div class="task-section-title">
                            <i class="bi bi-geo-alt"></i> 识别信息
                        </div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">图纸号 / Vendor Print</label>
                                <input type="text" class="form-control" name="DrawingNumber"
                                       value="{{ task.DrawingNumber if task else '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">TagNumber / 设备位号</label>
                                <input type="text" class="form-control" name="TagNumber"
                                       value="{{ task.TagNumber if task else '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">仪表点位 / PointTag</label>
                                <input type="text" class="form-control" name="PointTag"
                                       value="{{ task.PointTag if task else '' }}" placeholder="回路测试用">
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">任务描述</label>
                                <input type="text" class="form-control" name="Description"
                                       value="{{ task.Description if task else '' }}">
                            </div>
                        </div>
                    </div>

                    <div class="task-form-section">
                        <div class="task-section-title">
                            <i class="bi bi-collection"></i> 测试参数
                        </div>
                        <div class="row g-3">
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">测试类型</label>
                                <input type="text" class="form-control" name="TestType"
                                       value="{{ task.TestType if task else '' }}" placeholder="可选">
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">总数量</label>
                                <input type="number" min="0" class="form-control" name="QuantityTotal"
                                       value="{{ task.QuantityTotal if task else 1 }}">
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">已完成数量</label>
                                <input type="number" min="0" class="form-control" name="QuantityDone"
                                       value="{{ task.QuantityDone if task else 0 }}">
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <label class="form-label fw-bold">Performed by</label>
                                <input type="text" class="form-control" name="PerformedBy"
                                       value="{{ task.PerformedBy if task else '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">测试计划时间</label>
                                <input type="datetime-local" class="form-control" name="PlannedDate"
                                       value="{{ task.PlannedDate|replace(' ', 'T') if task and task.PlannedDate }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">测试实际时间</label>
                                <input type="datetime-local" class="form-control" name="ActualDate"
                                       value="{{ task.ActualDate|replace(' ', 'T') if task and task.ActualDate }}">
                            </div>
                        </div>
                    </div>

                    <div class="mt-3 d-flex justify-content-end gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> 保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if task %}
    <div class="col-12">
        <div class="card card-industrial task-attachments">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>测试资料附件</strong>
                <a href="{{ url_for('precom.precom_export_single_task', task_id=task.TaskID) }}" class="btn btn-sm btn-outline-success">
                    <i class="bi bi-download"></i> 导出
                </a>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">上传附件</label>
                    <div class="row g-2">
                        <div class="col-md-8 col-sm-12">
                            <input type="file" id="attachmentFiles" multiple class="form-control">
                        </div>
                        <div class="col-md-4 col-sm-12 d-grid">
                            <button class="btn btn-outline-primary" id="uploadAttachmentBtn">
                                <i class="bi bi-upload"></i> 上传附件
                            </button>
                        </div>
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 360px; overflow-y: auto;">
                    <table class="table table-sm align-middle table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>文件名</th>
                                <th class="text-end" style="width: 100px;">大小</th>
                            </tr>
                        </thead>
                        <tbody id="attachmentTableBody">
                            {% if attachments %}
                            {% for a in attachments %}
                            <tr>
                                <td><small>{{ a.FileName }}</small></td>
                                <td class="text-end"><small>{{ a.FileSize or 0 }}</small></td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="2" class="text-center text-muted py-3">暂无附件</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12">
        <div class="card card-industrial task-punch">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Punch List / 尾项</strong>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('precom.precom_punch_template', task_id=task.TaskID) }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-download"></i> 模板
                    </a>
                    <form id="punchImportForm" method="post" enctype="multipart/form-data"
                          action="{{ url_for('precom.precom_import_punch', task_id=task.TaskID) }}" class="mb-0">
                        <label class="btn btn-sm btn-outline-primary mb-0">
                            <i class="bi bi-upload"></i> 导入
                            <input type="file" name="file" accept=".xlsx,.xls" style="display:none" onchange="this.form.submit();">
                        </label>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-2 mb-3">
                    <div class="col-md-3 col-sm-6">
                        <input type="text" class="form-control form-control-sm" id="punchNoInput" placeholder="PUNCH NO.">
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <input type="text" class="form-control form-control-sm" id="refNoInput" placeholder="ISO / TAG">
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <input type="text" class="form-control form-control-sm" id="sheetNoInput" placeholder="SHEET NO.">
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <input type="text" class="form-control form-control-sm" id="revNoInput" placeholder="REV NO.">
                    </div>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" id="punchDescInput" placeholder="描述（必填）">
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <input type="text" class="form-control form-control-sm" id="punchCategoryInput" placeholder="CATEGORY">
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <input type="text" class="form-control form-control-sm" id="punchCauseInput" placeholder="CAUSE">
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <input type="text" class="form-control form-control-sm" id="punchIssuedInput" placeholder="ISSUED BY">
                    </div>
                    <div class="col-md-3 col-sm-6 d-flex align-items-center">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="rectifiedInput">
                            <label class="form-check-label" for="rectifiedInput">RECTIFIED</label>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 d-flex align-items-center">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="verifiedInput">
                            <label class="form-check-label" for="verifiedInput">VERIFIED</label>
                        </div>
                    </div>
                </div>
                <button class="btn btn-outline-primary mb-3" id="addPunchBtn">
                    <i class="bi bi-plus-circle"></i> 新增尾项
                </button>
                <div class="table-responsive" style="max-height: 360px; overflow-y: auto;">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Punch No.</th>
                                <th>ISO / Tag</th>
                                <th>Sheet</th>
                                <th>Rev</th>
                                <th>描述</th>
                                <th>Category</th>
                                <th>Cause</th>
                                <th>Issued By</th>
                                <th>Rectified</th>
                                <th>Verified</th>
                                <th class="text-end">操作</th>
                            </tr>
                        </thead>
                        <tbody id="punchTableBody">
                            {% if punches %}
                            {% for p in punches %}
                            <tr data-id="{{ p.ID }}">
                                <td><small>{{ p.PunchNo or '-' }}</small></td>
                                <td><small>{{ p.RefNo or '-' }}</small></td>
                                <td><small>{{ p.SheetNo or '-' }}</small></td>
                                <td><small>{{ p.RevNo or '-' }}</small></td>
                                <td><small>{{ p.Description }}</small></td>
                                <td><small>{{ p.Category or '-' }}</small></td>
                                <td><small>{{ p.Cause or '-' }}</small></td>
                                <td><small>{{ p.IssuedBy or '-' }}</small></td>
                                <td>
                                    {% if p.Rectified == 'Y' %}
                                    <span class="badge bg-success">是</span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">否</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if p.Verified == 'Y' %}
                                    <span class="badge bg-success">是</span>
                                    {% else %}
                                    <span class="badge bg-secondary">否</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-danger" data-action="delete-punch" title="删除">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="11" class="text-center text-muted py-3">暂无尾项</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
(function () {
    const taskId = {{ task.TaskID if task else 'null' }};

    // 系统-子系统级联
    const systemSelect = document.getElementById('SystemCode');
    const subsystemSelect = document.getElementById('SubSystemCode');
    if (systemSelect && subsystemSelect) {
        systemSelect.addEventListener('change', function () {
            const code = this.value;
            subsystemSelect.innerHTML = '<option value=\"\">请选择子系统</option>';
            if (!code) {
                return;
            }
            fetch('/api/subsystems/' + encodeURIComponent(code))
                .then(res => res.json())
                .then(data => {
                    data.forEach(function (sub) {
                        const opt = document.createElement('option');
                        opt.value = sub.SubSystemCode;
                        opt.textContent = sub.SubSystemCode;
                        subsystemSelect.appendChild(opt);
                    });
                })
                .catch(() => {
                    alert('加载子系统失败，请稍后重试。');
                });
        });
    }

    if (!taskId) {
        // 新建任务时，不需要附件和 Punch 的加载与删除逻辑
        return;
    }

    // 删除任务
    const deleteForm = document.getElementById('deleteTaskForm');
    const deleteBtn = document.getElementById('deleteTaskBtn');
    if (deleteForm && deleteBtn) {
        deleteBtn.addEventListener('click', function () {
            if (!confirm('确认删除该任务？该任务的附件和尾项也会一并删除。')) {
                return;
            }
            fetch(deleteForm.action, {
                method: 'POST'
            }).then(res => res.json())
              .then(data => {
                  if (!data.success) {
                      alert(data.error || '删除失败');
                  } else {
                      window.location.href = '{{ url_for("precom.precom_task_list") }}';
                  }
              })
              .catch(err => alert('删除失败：' + err));
        });
    }

    // 上传附件
    const uploadBtn = document.getElementById('uploadAttachmentBtn');
    const fileInput = document.getElementById('attachmentFiles');
    const attachmentBody = document.getElementById('attachmentTableBody');

    function reloadAttachments() {
        fetch(`/api/precom/tasks/${taskId}/attachments`)
            .then(res => res.json())
            .then(rows => {
                if (!rows.length) {
                    attachmentBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted py-3">暂无附件</td></tr>';
                    return;
                }
                attachmentBody.innerHTML = rows.map(a => `
                    <tr>
                        <td><small>${a.FileName}</small></td>
                        <td class="text-end"><small>${a.FileSize || 0}</small></td>
                    </tr>
                `).join('');
            })
            .catch(() => {
                attachmentBody.innerHTML = '<tr><td colspan="2" class="text-center text-danger py-3">附件加载失败</td></tr>';
            });
    }

    if (uploadBtn && fileInput) {
        uploadBtn.addEventListener('click', function () {
            if (!fileInput.files.length) {
                alert('请先选择需要上传的文件。');
                return;
            }
            const formData = new FormData();
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append('files', fileInput.files[i]);
            }
            uploadBtn.disabled = true;
            fetch(`/api/precom/tasks/${taskId}/attachments`, {
                method: 'POST',
                body: formData
            }).then(res => res.json())
              .then(data => {
                  if (!data.success) {
                      alert(data.error || '上传失败');
                  } else {
                      reloadAttachments();
                      fileInput.value = '';
                  }
              })
              .catch(err => {
                  alert('上传失败：' + err);
              })
              .finally(() => {
                  uploadBtn.disabled = false;
              });
        });
    }

    // Punch 列表
    const punchBody = document.getElementById('punchTableBody');
    const addPunchBtn = document.getElementById('addPunchBtn');
    const punchNoInput = document.getElementById('punchNoInput');
    const refNoInput = document.getElementById('refNoInput');
    const sheetNoInput = document.getElementById('sheetNoInput');
    const revNoInput = document.getElementById('revNoInput');
    const punchDescInput = document.getElementById('punchDescInput');
    const punchCategoryInput = document.getElementById('punchCategoryInput');
    const punchCauseInput = document.getElementById('punchCauseInput');
    const punchIssuedInput = document.getElementById('punchIssuedInput');
    const rectifiedInput = document.getElementById('rectifiedInput');
    const verifiedInput = document.getElementById('verifiedInput');

    function reloadPunchList() {
        fetch(`/api/precom/tasks/${taskId}/punch_list`)
            .then(res => res.json())
            .then(rows => {
                if (!rows.length) {
                    punchBody.innerHTML = '<tr><td colspan="11" class="text-center text-muted py-3">暂无尾项</td></tr>';
                    return;
                }
                punchBody.innerHTML = rows.map(p => `
                    <tr data-id="${p.ID}">
                        <td><small>${p.PunchNo || '-'}</small></td>
                        <td><small>${p.RefNo || '-'}</small></td>
                        <td><small>${p.SheetNo || '-'}</small></td>
                        <td><small>${p.RevNo || '-'}</small></td>
                        <td><small>${p.Description || ''}</small></td>
                        <td><small>${p.Category || '-'}</small></td>
                        <td><small>${p.Cause || '-'}</small></td>
                        <td><small>${p.IssuedBy || '-'}</small></td>
                        <td>
                            ${p.Rectified === 'Y'
                                ? '<span class="badge bg-success">是</span>'
                                : '<span class="badge bg-warning text-dark">否</span>'}
                        </td>
                        <td>
                            ${p.Verified === 'Y'
                                ? '<span class="badge bg-success">是</span>'
                                : '<span class="badge bg-secondary">否</span>'}
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-danger" data-action="delete-punch" title="删除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            })
            .catch(() => {
                punchBody.innerHTML = '<tr><td colspan="11" class="text-center text-danger py-3">尾项加载失败</td></tr>';
            });
    }

    if (addPunchBtn) {
        addPunchBtn.addEventListener('click', function () {
            const desc = (punchDescInput.value || '').trim();
            if (!desc) {
                alert('尾项描述为必填项。');
                return;
            }
            const payload = {
                PunchNo: punchNoInput.value || null,
                RefNo: refNoInput.value || null,
                SheetNo: sheetNoInput.value || null,
                RevNo: revNoInput.value || null,
                Description: desc,
                Category: punchCategoryInput.value || null,
                Cause: punchCauseInput.value || null,
                IssuedBy: punchIssuedInput.value || null,
                Rectified: rectifiedInput.checked ? 'Y' : 'N',
                Verified: verifiedInput.checked ? 'Y' : 'N'
            };
            addPunchBtn.disabled = true;
            fetch(`/api/precom/tasks/${taskId}/punch_list`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(res => res.json())
              .then(data => {
                  if (!data.success) {
                      alert(data.error || '保存失败');
                  } else {
                      punchNoInput.value = '';
                      refNoInput.value = '';
                      sheetNoInput.value = '';
                      revNoInput.value = '';
                      punchDescInput.value = '';
                      punchCategoryInput.value = '';
                      punchCauseInput.value = '';
                      punchIssuedInput.value = '';
                      rectifiedInput.checked = false;
                      verifiedInput.checked = false;
                      reloadPunchList();
                  }
              })
              .catch(err => {
                  alert('保存失败：' + err);
              })
              .finally(() => {
                  addPunchBtn.disabled = false;
              });
        });
    }

    if (punchBody) {
        punchBody.addEventListener('click', function (e) {
            const btn = e.target.closest('[data-action="delete-punch"]');
            if (!btn) return;
            const tr = btn.closest('tr');
            const id = tr && tr.getAttribute('data-id');
            if (!id) return;
            if (!confirm('确认删除该尾项？')) return;
            fetch(`/api/precom/tasks/${taskId}/punch_list/${id}`, {
                method: 'DELETE'
            }).then(res => res.json())
              .then(data => {
                  if (!data.success) {
                      alert(data.error || '删除失败');
                  } else {
                      reloadPunchList();
                  }
              })
              .catch(err => {
                  alert('删除失败：' + err);
              });
        });
    }
})();
</script>
{% endblock %}


