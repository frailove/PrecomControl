{% extends "base_industrial.html" %}

{% block title %}{{ _('è¯•å‹åŒ…ç®¡ç†') }} - {{ _('é¢„è¯•è½¦ç®¡ç†ç³»ç»Ÿ') }}{% endblock %}

{% block extra_styles %}
<style>
    .filter-section {
        background: white;
        padding: 1.25rem;
        margin-bottom: 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .table-container {
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        overflow: auto;
        max-height: calc(100vh - 320px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .table-container thead th {
        position: sticky;
        top: 0;
        background: linear-gradient(180deg, #eef2ff 0%, #e2e8f0 100%);
        color: #0f172a;
        font-weight: 700;
        z-index: 2;
        box-shadow: 0 2px 4px rgba(15, 23, 42, 0.15);
        text-align: center;
    }

    .mini-stat-wrap {
        gap: 0.5rem;
    }
    .stat-card {
        background: white;
        padding: 0.65rem 0.9rem;
        border: 2px solid var(--border-color);
        border-left: 5px solid var(--primary-blue);
        border-radius: 8px;
        text-align: center;
        min-width: 140px;
    }
    .faclist-scroll {
        display: flex;
        gap: 0.6rem;
        overflow-x: auto;
        padding: 0.25rem 0;
    }
    .faclist-scroll .form-select {
        min-width: 150px;
        white-space: nowrap;
    }
    .mini-card h3 {
        font-size: 1.2rem;
        font-weight: 800;
        color: var(--primary-blue);
        margin: 0;
    }
    .mini-card p {
        font-size: 0.7rem;
        color: var(--text-secondary);
        margin: 0.1rem 0 0;
        letter-spacing: 0.3px;
        text-transform: uppercase;
    }

    .status-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        border-radius: 999px;
        font-size: 0.72rem;
        font-weight: 700;
        padding: 0.35rem 0.85rem;
        letter-spacing: 0.05em;
        border: 1px solid rgba(15,23,42,0.12);
        text-transform: uppercase;
    }

    .status-chip.success {
        background: #dcfce7;
        color: #166534;
        border-color: #4ade80;
    }

    .status-chip.muted {
        background: #f8fafc;
        color: #94a3b8;
        border-color: #e2e8f0;
    }

    .stage-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.45rem 1.1rem;
        border-radius: 999px;
        font-weight: 800;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        font-size: 0.78rem;
        min-width: 120px;
    }

    .stage-badge.success { background: #16a34a; color: #fff; }
    .stage-badge.info { background: #bae6fd; color: #0c4a6e; }
    .stage-badge.warning { background: #fef3c7; color: #92400e; }
    .stage-badge.secondary { background: #e2e8f0; color: #475569; }
    
    .test-package-table tbody td {
        padding: 0.5rem 0.65rem;
        vertical-align: middle;
    }
    
    .tp-action-buttons {
        display: flex;
        gap: 0.35rem;
        flex-wrap: nowrap;
    }
    
    .tp-action-buttons .btn-sm {
        padding: 0.3rem 0.55rem;
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- é¡µé¢å¤´éƒ¨ -->
<div class="page-header d-flex justify-content-between align-items-end">
    <div>
        <h1>
            <i class="bi bi-box-seam-fill"></i>
            {{ _('è¯•å‹åŒ…ç®¡ç†') }}
        </h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/"><i class="bi bi-house-door"></i> {{ _('é¦–é¡µ') }}</a></li>
                <li class="breadcrumb-item active">{{ _('è¯•å‹åŒ…ç®¡ç†') }}</li>
            </ol>
        </nav>
    </div>
    <div class="row g-2 mini-stat-wrap text-end">
        <div class="col-auto">
            <div class="stat-card mini-card">
                <h3>{{ total_count }}</h3>
                <p>{{ _('æ€»è¯•å‹åŒ…æ•°') }}</p>
            </div>
        </div>
        <div class="col-auto">
            <div class="stat-card mini-card border-left-success">
                <h3>{{ completed_count }}</h3>
                <p>{{ _('å·²å®Œæˆ') }}</p>
            </div>
        </div>
        <div class="col-auto">
            <div class="stat-card mini-card border-left-warning">
                <h3>{{ in_progress_count }}</h3>
                <p>{{ _('è¿›è¡Œä¸­') }}</p>
            </div>
        </div>
        <div class="col-auto">
            <div class="stat-card mini-card border-left-orange">
                <h3>{{ pending_count }}</h3>
                <p>{{ _('å¾…å¤„ç†') }}</p>
            </div>
        </div>
    </div>
</div>

<!-- æœç´¢å’Œç­›é€‰ -->
<div class="filter-section">
    <form method="GET" action="/test_packages" id="filterForm">
        <!-- ç¬¬ä¸€è¡Œï¼šåŸºæœ¬ç­›é€‰ -->
        <div class="filter-row">
            <div class="row g-2">
                <div class="col-md-2">
                    <input type="text" class="form-control" name="q" placeholder="{{ _('æœç´¢') }}..." value="{{ search_query }}">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control" name="system_code" id="testPackageSystemCodeInput"
                           placeholder="{{ _('é€‰æ‹©ç³»ç»Ÿ') }}" value="{{ filter_system }}"
                           list="testPackageSystemCodeAutocompleteList" autocomplete="off">
                    <datalist id="testPackageSystemCodeAutocompleteList"></datalist>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control" name="subsystem_code" id="testPackageSubsystemCodeInput"
                           placeholder="{{ _('é€‰æ‹©å­ç³»ç»Ÿ') }}" value="{{ filter_subsystem }}"
                           list="testPackageSubsystemCodeAutocompleteList" autocomplete="off">
                    <datalist id="testPackageSubsystemCodeAutocompleteList"></datalist>
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="status">
                        <option value="">{{ _('å…¨éƒ¨çŠ¶æ€') }}</option>
                        <option value="Pending" {% if filter_status == 'Pending' %}selected{% endif %}>{{ _('å¾…å¤„ç†') }}</option>
                        <option value="In Progress" {% if filter_status == 'In Progress' %}selected{% endif %}>{{ _('è¿›è¡Œä¸­') }}</option>
                        <option value="Completed" {% if filter_status == 'Completed' %}selected{% endif %}>{{ _('å·²å®Œæˆ') }}</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1">
                            <i class="bi bi-search"></i> {{ _('æœç´¢') }}
                        </button>
                        <a href="/test_packages" class="btn btn-secondary">
                            <i class="bi bi-arrow-clockwise"></i> {{ _('é‡ç½®') }}
                        </a>
                        <button type="button" class="btn btn-warning" onclick="toggleFaclistFilter()">
                            <i class="bi bi-funnel"></i> {{ _('ç­›é€‰') }}
                        </button>
                        <a class="btn btn-outline-warning" href="/test_packages/alerts">
                            <i class="bi bi-activity"></i> {{ _('ç¼–åˆ¶æé†’') }}
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç¬¬äºŒè¡Œï¼šFaclisté«˜çº§ç­›é€‰ï¼ˆå¯æŠ˜å ï¼‰ -->
        <div id="faclistFilter" {% if (filter_subproject or filter_train or filter_unit or filter_simpleblk or filter_mainblock or filter_block or filter_bccquarter) %}style="display: block;"{% else %}style="display: none;"{% endif %}>
    <hr style="margin: 0.75rem 0;">
    <div class="faclist-scroll">
        <select class="form-select" name="subproject_code">
            <option value="">{{ _('å…¨éƒ¨') }} SubProject</option>
            {% for code in faclist_options.subproject_codes %}
            <option value="{{ code }}" {% if code == filter_subproject %}selected{% endif %}>{{ code }}</option>
            {% endfor %}
        </select>
        <select class="form-select" name="train">
            <option value="">{{ _('å…¨éƒ¨') }} Train</option>
            {% for train in faclist_options.trains %}
            <option value="{{ train }}" {% if train == filter_train %}selected{% endif %}>{{ train }}</option>
            {% endfor %}
        </select>
        <select class="form-select" name="unit">
            <option value="">å…¨éƒ¨è£…ç½®</option>
            {% for unit in faclist_options.units %}
            <option value="{{ unit }}" {% if unit == filter_unit %}selected{% endif %}>{{ unit }}</option>
            {% endfor %}
        </select>
        <select class="form-select" name="simpleblk">
            <option value="">å…¨éƒ¨å¤§ä¸»é¡¹</option>
            {% for blk in faclist_options.simpleblks %}
            <option value="{{ blk }}" {% if blk == filter_simpleblk %}selected{% endif %}>{{ blk }}</option>
            {% endfor %}
        </select>
        <select class="form-select" name="mainblock">
            <option value="">å…¨éƒ¨ä¸»é¡¹</option>
            {% if filter_simpleblk and faclist_options.mainblocks.get(filter_simpleblk) %}
                {% for mb in faclist_options.mainblocks[filter_simpleblk]|sort %}
                <option value="{{ mb }}" {% if mb == filter_mainblock %}selected{% endif %}>{{ mb }}</option>
                {% endfor %}
            {% else %}
                {% set all_mainblocks = [] %}
                {% for simpleblk, mainblocks in faclist_options.mainblocks.items() %}
                    {% for mb in mainblocks %}
                        {% if mb not in all_mainblocks %}
                            {% set _ = all_mainblocks.append(mb) %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                {% for mb in all_mainblocks|sort %}
                <option value="{{ mb }}" {% if mb == filter_mainblock %}selected{% endif %}>{{ mb }}</option>
                {% endfor %}
            {% endif %}
        </select>
        <select class="form-select" name="block">
            <option value="">å…¨éƒ¨CIAä¸»å­é¡¹</option>
            {% if filter_mainblock and faclist_options.blocks.get(filter_mainblock) %}
                {% for b in faclist_options.blocks[filter_mainblock]|sort %}
                <option value="{{ b }}" {% if b == filter_block %}selected{% endif %}>{{ b }}</option>
                {% endfor %}
            {% else %}
                {% set all_blocks = [] %}
                {% for mainblock, blocks in faclist_options.blocks.items() %}
                    {% for b in blocks %}
                        {% if b not in all_blocks %}
                            {% set _ = all_blocks.append(b) %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                {% for b in all_blocks|sort %}
                <option value="{{ b }}" {% if b == filter_block %}selected{% endif %}>{{ b }}</option>
                {% endfor %}
            {% endif %}
        </select>
        <select class="form-select" name="bccquarter">
            <option value="">å…¨éƒ¨ç‰‡åŒº</option>
            {% for quarter in faclist_options.bccquarters %}
            <option value="{{ quarter }}" {% if quarter == filter_bccquarter %}selected{% endif %}>{{ quarter }}</option>
            {% endfor %}
        </select>
    </div>
</div>
    </form>
</div>

<!-- è¡¨æ ¼ -->
<div class="table-container">
    <table class="table table-hover mb-0 test-package-table">
        <thead>
            <tr>
                <th style="width: 180px;">{{ _('è¯•å‹åŒ…ID') }}</th>
                <th style="width: 100px;">{{ _('ç³»ç»Ÿ') }}</th>
                <th style="width: 120px;">{{ _('å­ç³»ç»Ÿ') }}</th>
                <th style="width: 210px;">{{ _('ç„Šå£ / DIN è¿›åº¦') }}</th>
                <th style="width: 180px;">{{ _('èµ„æ–™å‡†å¤‡') }}</th>
                <th style="width: 160px;">{{ _('é˜¶æ®µçŠ¶æ€') }}</th>
                <th style="width: 110px;">{{ _('è®¡åˆ’æ—¥æœŸ') }}</th>
                <th style="width: 110px;">{{ _('å®é™…æ—¥æœŸ') }}</th>
                <th style="width: 120px;">{{ _('çŠ¶æ€') }}</th>
                <th style="width: 180px;">{{ _('æ“ä½œ') }}</th>
            </tr>
        </thead>
        <tbody>
            {% if packages %}
                {% for package in packages %}
                <tr>
                    <td><strong>{{ package.TestPackageID }}</strong></td>
                    <td class="text-center">{{ package.SystemCode or '-' }}</td>
                    <td class="text-center">{{ package.SubSystemCode or '-' }}</td>
                    <td>
                        {% if package.welding_status.total_din > 0 %}
                        <div class="d-flex justify-content-between small text-muted">
                            <span>{{ package.welding_status.completed_din|round(1) }} / {{ package.welding_status.total_din|round(1) }} DIN</span>
                            <span>{{ package.welding_status.progress_pct }}%</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            {% set progress_width = package.welding_status.progress_pct|default(0)|round %}
                            <div class="progress-bar {{ 'bg-success' if package.welding_status.joints_complete else 'bg-warning' }}"
                                 data-progress="{{ progress_width }}"
                                 style="width: 0%;"></div>
                        </div>
                        {% else %}
                        <span class="text-muted small">{{ _('æ— ç„Šå£æ•°æ®') }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex flex-column gap-1">
                            <span class="status-chip {{ 'success' if package.info_status.basic else 'muted' }}">
                                <i class="bi bi-info-circle-fill"></i> {{ _('åŸºç¡€ä¿¡æ¯') }}
                            </span>
                            <span class="status-chip {{ 'success' if package.info_status.attachments and package.drawings_ready else 'muted' }}">
                                <i class="bi bi-archive-fill"></i> {{ _('é™„ä»¶/å›¾çº¸') }}
                            </span>
                        </div>
                    </td>
                    <td class="text-center">
                        {% set stage_color = package.status_info.status_color %}
                        <div class="stage-badge {{ stage_color }}">
                            {{ _(package.status_info.status_name) }}
                        </div>
                        <div class="text-muted small mt-1">{{ _(package.status_info.status_description) }}</div>
                    </td>
                    <td class="text-center">{{ package.PlannedDate or '-' }}</td>
                    <td class="text-center">{{ package.ActualDate or '-' }}</td>
                    <td class="text-center">
                        {% if package.Status == 'Completed' %}
                        <span class="badge badge-completed">
                            <i class="bi bi-circle-fill"></i>
                            {{ package.Status }}
                        </span>
                        {% elif package.Status == 'In Progress' %}
                        <span class="badge badge-inprogress">
                            <i class="bi bi-circle-fill"></i>
                            {{ package.Status }}
                        </span>
                        {% else %}
                        <span class="badge badge-pending">
                            <i class="bi bi-circle-fill"></i>
                            {{ package.Status }}
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="tp-action-buttons">
                            <a href="/test_packages/edit/{{ package.TestPackageID|urlencode }}" class="btn btn-sm btn-primary">
                                <i class="bi bi-pencil"></i> {{ _('ç¼–è¾‘') }}
                            </a>
                            <button type="button"
                                    class="btn btn-sm btn-success"
                                    data-bs-toggle="modal"
                                    data-bs-target="#exportModal"
                                    data-package-id="{{ package.TestPackageID }}">
                                <i class="bi bi-download"></i> {{ _('å¯¼å‡º') }}
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="10" class="text-center text-muted py-4">
                        <i class="bi bi-inbox"></i> {{ _('æš‚æ— æ•°æ®') }}
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- åˆ†é¡µä¿¡æ¯ -->
{% if packages %}
<div class="d-flex flex-wrap justify-content-between align-items-center mt-3 gap-2">
    <div class="text-muted small">
        {% if total_count %}
        æ˜¾ç¤ºç¬¬ {{ pagination.start_index }} - {{ pagination.end_index }} æ¡ï¼Œå…± {{ total_count }} æ¡
        {% endif %}
    </div>
    {% if pagination.total_pages > 1 %}
    <nav>
        <ul class="pagination pagination-sm mb-0">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ pagination.prev_url if pagination.has_prev else '#' }}">ä¸Šä¸€é¡µ</a>
            </li>
            {% for page_num in pagination.window %}
            <li class="page-item {% if page_num == pagination.current_page %}active{% endif %}">
                <a class="page-link" href="{{ pagination.base_url }}{{ page_num }}">{{ page_num }}</a>
            </li>
            {% endfor %}
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ pagination.next_url if pagination.has_next else '#' }}">ä¸‹ä¸€é¡µ</a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>
{% endif %}

<!-- å¯¼å‡ºé€‰é¡¹å¼¹çª— -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">å¯¼å‡ºè¯•å‹åŒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">è¯·é€‰æ‹©å¯¼å‡ºæ–¹å¼ï¼š</p>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exportOption" id="exportExcelOnly" value="excel" checked>
                    <label class="form-check-label" for="exportExcelOnly">
                        ä»…å¯¼å‡º Excel
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exportOption" id="exportWithAttachments" value="with_attachments">
                    <label class="form-check-label" for="exportWithAttachments">
                        å¯¼å‡º Excel + é™„ä»¶ï¼ˆZIPï¼Œå«æ‰€æœ‰é™„ä»¶ï¼‰
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" id="exportConfirmBtn">
                    <i class="bi bi-cloud-download"></i> å¯¼å‡º
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// åˆ‡æ¢Faclistç­›é€‰æ˜¾ç¤º
function toggleFaclistFilter() {
    var filterDiv = document.getElementById('faclistFilter');
    if (filterDiv.style.display === 'none') {
        filterDiv.style.display = 'block';
    } else {
        filterDiv.style.display = 'none';
    }
}

$(document).ready(function() {
    // åˆå§‹åŒ–è¿›åº¦æ¡å®½åº¦
    $('.progress-bar[data-progress]').each(function() {
        var progress = $(this).data('progress');
        $(this).css('width', progress + '%');
    });
    
    // é˜²æ­¢é‡å¤æäº¤çš„æ ‡è®°
    var isSubmitting = false;
    var submitTimer;
    
    console.log('âœ… jQueryåŠ è½½æˆåŠŸ');
    console.log('ğŸ“ Faclistç­›é€‰å­—æ®µæ•°é‡:', $('select[name="subproject_code"], select[name="train"], select[name="unit"], select[name="simpleblk"], select[name="mainblock"], select[name="block"], select[name="bccquarter"]').length);
    
    // ç³»ç»Ÿä»£ç å˜åŒ–æ—¶ï¼ŒåŠ è½½å¯¹åº”çš„å­ç³»ç»Ÿï¼ˆAJAXï¼Œä¸åˆ·æ–°é¡µé¢ï¼‰
    // ç³»ç»Ÿä»£ç autocomplete
    var testPackageSystemCodeInput = document.getElementById('testPackageSystemCodeInput');
    var testPackageSystemCodeAutocompleteList = document.getElementById('testPackageSystemCodeAutocompleteList');
    var testPackageSystemCodeTimer = null;
    
    if (testPackageSystemCodeInput && testPackageSystemCodeAutocompleteList) {
        // åˆå§‹åŒ–æ—¶åŠ è½½æ‰€æœ‰ç³»ç»Ÿ
        fetch('/api/systems/autocomplete?limit=100')
            .then(response => response.json())
            .then(data => {
                testPackageSystemCodeAutocompleteList.innerHTML = '';
                data.forEach(function(item) {
                    var option = document.createElement('option');
                    option.value = item.code;
                    option.textContent = item.label;
                    testPackageSystemCodeAutocompleteList.appendChild(option);
                });
            });
        
        testPackageSystemCodeInput.addEventListener('input', function() {
            var query = this.value.trim();
            clearTimeout(testPackageSystemCodeTimer);
            
            if (query.length < 1) {
                fetch('/api/systems/autocomplete?limit=100')
                    .then(response => response.json())
                    .then(data => {
                        testPackageSystemCodeAutocompleteList.innerHTML = '';
                        data.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.code;
                            option.textContent = item.label;
                            testPackageSystemCodeAutocompleteList.appendChild(option);
                        });
                    });
                return;
            }
            
            testPackageSystemCodeTimer = setTimeout(function() {
                fetch('/api/systems/autocomplete?q=' + encodeURIComponent(query) + '&limit=20')
                    .then(response => response.json())
                    .then(data => {
                        testPackageSystemCodeAutocompleteList.innerHTML = '';
                        data.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.code;
                            option.textContent = item.label;
                            testPackageSystemCodeAutocompleteList.appendChild(option);
                        });
                    });
            }, 300);
        });
        
        // ç³»ç»Ÿä»£ç å˜åŒ–æ—¶ï¼Œæ›´æ–°å­ç³»ç»Ÿé€‰é¡¹å’ŒFaclist
        $(testPackageSystemCodeInput).on('change input', function() {
            var systemCode = this.value.trim();
            console.log('ğŸ”„ ç³»ç»Ÿå˜åŒ–:', systemCode);
            
            // æ¸…ç©ºå­ç³»ç»Ÿé€‰æ‹©
            var subsystemInput = document.getElementById('testPackageSubsystemCodeInput');
            if (subsystemInput) {
                subsystemInput.value = '';
            }
            
            if (systemCode) {
                $.get("/api/subsystems/" + systemCode, function(data) {
                    var subsystemAutocompleteList = document.getElementById('testPackageSubsystemCodeAutocompleteList');
                    if (subsystemAutocompleteList) {
                        subsystemAutocompleteList.innerHTML = '';
                        data.forEach(function(subsystem) {
                            var option = document.createElement('option');
                            option.value = subsystem.SubSystemCode;
                            option.textContent = subsystem.SubSystemCode + ' - ' + (subsystem.SubSystemDescriptionENG || '');
                            subsystemAutocompleteList.appendChild(option);
                        });
                    }
                    console.log('âœ… å­ç³»ç»Ÿé€‰é¡¹å·²æ›´æ–°');
                });
            } else {
                var subsystemAutocompleteList = document.getElementById('testPackageSubsystemCodeAutocompleteList');
                if (subsystemAutocompleteList) {
                    subsystemAutocompleteList.innerHTML = '';
                }
            }
            
            // åŒæ—¶æ›´æ–°Faclisté€‰é¡¹ï¼ˆç³»ç»Ÿå¯èƒ½å½±å“Faclistï¼‰
            clearTimeout(submitTimer);
            submitTimer = setTimeout(function() {
                updateFaclistOptions('system_code');
            }, 300);
        });
    }
    
    // å­ç³»ç»Ÿä»£ç autocomplete
    var testPackageSubsystemCodeInput = document.getElementById('testPackageSubsystemCodeInput');
    var testPackageSubsystemCodeAutocompleteList = document.getElementById('testPackageSubsystemCodeAutocompleteList');
    var testPackageSubsystemCodeTimer = null;
    
    if (testPackageSubsystemCodeInput && testPackageSubsystemCodeAutocompleteList) {
        testPackageSubsystemCodeInput.addEventListener('input', function() {
            var query = this.value.trim();
            var systemCode = testPackageSystemCodeInput ? testPackageSystemCodeInput.value.trim() : '';
            clearTimeout(testPackageSubsystemCodeTimer);
            
            if (query.length < 1) {
                testPackageSubsystemCodeAutocompleteList.innerHTML = '';
                return;
            }
            
            testPackageSubsystemCodeTimer = setTimeout(function() {
                var url = '/api/subsystems/autocomplete?q=' + encodeURIComponent(query) + '&limit=20';
                if (systemCode) {
                    url += '&system_code=' + encodeURIComponent(systemCode);
                }
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        testPackageSubsystemCodeAutocompleteList.innerHTML = '';
                        data.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.code;
                            option.textContent = item.label;
                            testPackageSubsystemCodeAutocompleteList.appendChild(option);
                        });
                    });
            }, 300);
        });
        
        // å­ç³»ç»Ÿä»£ç å˜åŒ–æ—¶ï¼Œæ›´æ–°Faclisté€‰é¡¹
        $(testPackageSubsystemCodeInput).on('change input', function() {
            var subsystemCode = this.value.trim();
            console.log('ğŸ”„ å­ç³»ç»Ÿå˜åŒ–:', subsystemCode);
        
            // æ›´æ–°Faclisté€‰é¡¹ï¼ˆå­ç³»ç»Ÿå¯èƒ½å½±å“Faclistï¼‰
            clearTimeout(submitTimer);
            submitTimer = setTimeout(function() {
                updateFaclistOptions('subsystem_code');
            }, 300);
        });
    }
    
    // Faclistçº§è”ç­›é€‰ - ä½¿ç”¨AJAXæ›´æ–°é€‰é¡¹ï¼ˆä¸åˆ·æ–°é¡µé¢ï¼‰
    function updateFaclistOptions(changedField) {
        // æ”¶é›†å½“å‰æ‰€æœ‰ç­›é€‰æ¡ä»¶ï¼ˆåŒ…æ‹¬ç³»ç»Ÿã€å­ç³»ç»Ÿã€Faclistæ‰€æœ‰å­—æ®µï¼‰
        var params = {
            system_code: $('#testPackageSystemCodeInput').val() || '',
            subsystem_code: $('#testPackageSubsystemCodeInput').val() || '',
            subproject_code: $('select[name="subproject_code"]').val() || '',
            train: $('select[name="train"]').val() || '',
            unit: $('select[name="unit"]').val() || '',
            simpleblk: $('select[name="simpleblk"]').val() || '',
            mainblock: $('select[name="mainblock"]').val() || '',
            block: $('select[name="block"]').val() || '',
            bccquarter: $('select[name="bccquarter"]').val() || ''
        };
        
        console.log('ğŸ”„ æ›´æ–°Faclisté€‰é¡¹ï¼ˆå˜åŒ–å­—æ®µ: ' + changedField + '):', params);
        
        // AJAXè¯·æ±‚æ›´æ–°é€‰é¡¹
        $.get('/api/faclist_options', params, function(data) {
            console.log('âœ… æ”¶åˆ°æ–°é€‰é¡¹:', data);
            
            // æ›´æ–°é¡¹ç›®ï¼ˆä¸æ›´æ–°è‡ªå·±ï¼‰
            if (changedField !== 'subproject_code') {
                var subprojectSelect = $('select[name="subproject_code"]');
                var currentSubproject = subprojectSelect.val();
                subprojectSelect.empty().append('<option value="">å…¨éƒ¨é¡¹ç›®</option>');
                $.each(data.subproject_codes || [], function(i, code) {
                    subprojectSelect.append('<option value="' + code + '">' + code + '</option>');
                });
                if (currentSubproject) subprojectSelect.val(currentSubproject);
            }
            
            // æ›´æ–°é¡¹ç›®æœŸï¼ˆä¸æ›´æ–°è‡ªå·±ï¼‰
            if (changedField !== 'train') {
                var trainSelect = $('select[name="train"]');
                var currentTrain = trainSelect.val();
                trainSelect.empty().append('<option value="">å…¨éƒ¨é¡¹ç›®æœŸ</option>');
                $.each(data.trains || [], function(i, train) {
                    trainSelect.append('<option value="' + train + '">' + train + '</option>');
                });
                if (currentTrain) trainSelect.val(currentTrain);
            }
            
            // æ›´æ–°è£…ç½®ï¼ˆä¸æ›´æ–°è‡ªå·±ï¼‰
            if (changedField !== 'unit') {
                var unitSelect = $('select[name="unit"]');
                var currentUnit = unitSelect.val();
                unitSelect.empty().append('<option value="">å…¨éƒ¨è£…ç½®</option>');
                $.each(data.units || [], function(i, unit) {
                    unitSelect.append('<option value="' + unit + '">' + unit + '</option>');
                });
                if (currentUnit) unitSelect.val(currentUnit);
            }
            
            // æ›´æ–°å¤§ä¸»é¡¹ï¼ˆä¸æ›´æ–°è‡ªå·±ï¼‰
            if (changedField !== 'simpleblk') {
                var simpleblkSelect = $('select[name="simpleblk"]');
                var currentSimpleblk = simpleblkSelect.val();
                simpleblkSelect.empty().append('<option value="">å…¨éƒ¨å¤§ä¸»é¡¹</option>');
                $.each(data.simpleblks || [], function(i, blk) {
                    simpleblkSelect.append('<option value="' + blk + '">' + blk + '</option>');
                });
                if (currentSimpleblk) simpleblkSelect.val(currentSimpleblk);
            }
            
            // æ›´æ–°ä¸»é¡¹ï¼ˆä¸æ›´æ–°è‡ªå·±ï¼‰
            if (changedField !== 'mainblock') {
                var mainblockSelect = $('select[name="mainblock"]');
                var currentMainblock = mainblockSelect.val();
                mainblockSelect.empty().append('<option value="">å…¨éƒ¨ä¸»é¡¹</option>');
                var currentSimpleBLK = $('select[name="simpleblk"]').val();
                if (currentSimpleBLK && data.mainblocks && data.mainblocks[currentSimpleBLK]) {
                    $.each(data.mainblocks[currentSimpleBLK].sort(), function(i, mb) {
                        mainblockSelect.append('<option value="' + mb + '">' + mb + '</option>');
                    });
                } else {
                    // æ˜¾ç¤ºæ‰€æœ‰MainBlock
                    var allMainblocks = [];
                    $.each(data.mainblocks || {}, function(simpleblk, mbs) {
                        $.each(mbs, function(i, mb) {
                            if (allMainblocks.indexOf(mb) === -1) {
                                allMainblocks.push(mb);
                            }
                        });
                    });
                    allMainblocks.sort();
                    $.each(allMainblocks, function(i, mb) {
                        mainblockSelect.append('<option value="' + mb + '">' + mb + '</option>');
                    });
                }
                if (currentMainblock) mainblockSelect.val(currentMainblock);
            }
            
            // æ›´æ–°Blockï¼ˆä¸æ›´æ–°è‡ªå·±ï¼‰
            if (changedField !== 'block') {
                var blockSelect = $('select[name="block"]');
                var currentBlock = blockSelect.val();
                blockSelect.empty().append('<option value="">å…¨éƒ¨CIAä¸»å­é¡¹</option>');
                var currentMainBlock = $('select[name="mainblock"]').val();
                if (currentMainBlock && data.blocks && data.blocks[currentMainBlock]) {
                    $.each(data.blocks[currentMainBlock].sort(), function(i, b) {
                        blockSelect.append('<option value="' + b + '">' + b + '</option>');
                    });
                } else {
                    // æ˜¾ç¤ºæ‰€æœ‰Block
                    var allBlocks = [];
                    $.each(data.blocks || {}, function(mainblock, bs) {
                        $.each(bs, function(i, b) {
                            if (allBlocks.indexOf(b) === -1) {
                                allBlocks.push(b);
                            }
                        });
                    });
                    allBlocks.sort();
                    $.each(allBlocks, function(i, b) {
                        blockSelect.append('<option value="' + b + '">' + b + '</option>');
                    });
                }
                if (currentBlock) blockSelect.val(currentBlock);
            }
            
            // æ›´æ–°ç‰‡åŒºï¼ˆä¸æ›´æ–°è‡ªå·±ï¼‰
            if (changedField !== 'bccquarter') {
                var quarterSelect = $('select[name="bccquarter"]');
                var currentQuarter = quarterSelect.val();
                quarterSelect.empty().append('<option value="">å…¨éƒ¨ç‰‡åŒº</option>');
                $.each(data.bccquarters || [], function(i, quarter) {
                    quarterSelect.append('<option value="' + quarter + '">' + quarter + '</option>');
                });
                if (currentQuarter) quarterSelect.val(currentQuarter);
            }
            
            console.log('âœ… Faclisté€‰é¡¹æ›´æ–°å®Œæˆï¼ˆæœªåˆ·æ–°é¡µé¢ï¼‰');
        }).fail(function(xhr, status, error) {
            console.error('âŒ è·å–Faclisté€‰é¡¹å¤±è´¥:', status, error);
        });
    }
    
    // æ‰€æœ‰Faclistå­—æ®µå˜åŒ–æ—¶ï¼Œé€šè¿‡AJAXæ›´æ–°é€‰é¡¹ï¼ˆä¸åˆ·æ–°é¡µé¢ï¼‰
    $('select[name="subproject_code"], select[name="train"], select[name="unit"], select[name="simpleblk"], select[name="mainblock"], select[name="block"], select[name="bccquarter"]').change(function() {
        var changedField = $(this).attr('name');
        var changedValue = $(this).val();
        
        console.log('ğŸ”„ Faclistå­—æ®µå˜åŒ–:', changedField, '=', changedValue);
        
        // æ ¹æ®å˜åŒ–çš„å­—æ®µï¼Œæ¸…ç©ºç›¸å…³çš„ä¸‹çº§å­—æ®µ
        if (changedField === 'simpleblk') {
            console.log('æ¸…ç©ºMainBlockå’ŒBlock');
            $('select[name="mainblock"]').val('');
            $('select[name="block"]').val('');
        } else if (changedField === 'mainblock') {
            console.log('æ¸…ç©ºBlock');
            $('select[name="block"]').val('');
        }
        
        // é€šè¿‡AJAXæ›´æ–°Faclisté€‰é¡¹ï¼ˆä¸åˆ·æ–°é¡µé¢ï¼‰
        // ä¼ é€’changedFieldï¼Œè¿™æ ·è¯¥å­—æ®µçš„é€‰é¡¹ä¸ä¼šè¢«æ›´æ–°ï¼ˆä¿æŒå…¨éƒ¨é€‰é¡¹ï¼‰
        clearTimeout(submitTimer);
        submitTimer = setTimeout(function() {
            updateFaclistOptions(changedField);
        }, 300);
    });
    var exportModalEl = document.getElementById('exportModal');
    var exportModalInstance = bootstrap.Modal.getOrCreateInstance(exportModalEl);
    var exportPackageId = null;
    exportModalEl.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        exportPackageId = button.getAttribute('data-package-id');
        document.getElementById('exportExcelOnly').checked = true;
    });
    document.getElementById('exportConfirmBtn').addEventListener('click', function() {
        if (!exportPackageId) return;
        var includeAttachments = document.getElementById('exportWithAttachments').checked;
        var url = `/test_packages/${encodeURIComponent(exportPackageId)}/export_package`;
        if (includeAttachments) {
            url += '?include_attachments=true';
        }
        exportModalInstance.hide();
        setTimeout(function() {
            window.location.href = url;
        }, 200);
    });
});

</script>
{% endblock %}

