{% extends "base_industrial.html" %}

{% block title %}子系统管理 - 预试车管理系统{% endblock %}

{% block extra_styles %}
<style>
    .filter-section {
        background: white;
        padding: 1.25rem;
        margin-bottom: 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .table-container {
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .action-buttons {
        display: flex;
        gap: 0.375rem;
    }
    
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
    }
    
    .stat-card {
        background: white;
    padding: 0.65rem 0.9rem;
        border: 2px solid var(--border-color);
        border-left: 5px solid var(--primary-blue);
        border-radius: 8px;
        text-align: center;
    min-width: 140px;
    }
    
    .faclist-scroll {
        display: flex;
        gap: 0.6rem;
        overflow-x: auto;
        padding: 0.25rem 0;
    }
    
    .faclist-scroll .form-select {
        min-width: 150px;
        white-space: nowrap;
    }
    
    .stat-card h3 {
        font-size: 1.2rem;
        font-weight: 800;
        color: var(--primary-blue);
        margin: 0;
    }
    
    .stat-card p {
        font-size: 0.7rem;
        color: var(--text-secondary);
        margin: 0.15rem 0 0;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    
    .progress-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.72rem;
        color: var(--text-secondary);
        margin-bottom: 0.2rem;
    }
    
    .progress-thin {
        height: 6px;
        border-radius: 999px;
        overflow: hidden;
        background: #e9ecef;
    }
    
    .progress-thin .progress-bar {
        height: 100%;
    }
</style>
{% endblock %}

{% block content %}
<!-- 页面头部 -->
<div class="page-header d-flex justify-content-between align-items-end">
    <div>
        <h1>
            <i class="bi bi-bezier2"></i>
            {{ _('子系统管理') }}
        </h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/"><i class="bi bi-house-door"></i> {{ _('首页') }}</a></li>
                <li class="breadcrumb-item active">{{ _('子系统管理') }}</li>
            </ol>
        </nav>
    </div>
    <div class="row g-2 mini-stat-wrap text-end">
        <div class="col-auto">
            <div class="stat-card mini-card">
                <h3>{{ total_count }}</h3>
                <p>{{ _('总子系统数') }}</p>
            </div>
        </div>
        <div class="col-auto">
            <div class="stat-card mini-card border-left-success">
                <h3>{{ process_count }}</h3>
                <p>{{ _('工艺系统') }}</p>
            </div>
        </div>
        <div class="col-auto">
            <div class="stat-card mini-card border-left-orange">
                <h3>{{ non_process_count }}</h3>
                <p>{{ _('非工艺系统') }}</p>
            </div>
        </div>
    </div>
</div>

<!-- 筛选区域 -->
<div class="filter-section">
    <form method="GET" action="/subsystems" id="filterForm">
        <!-- 第一行：基本筛选 -->
        <div class="filter-row">
            <div class="row g-2">
                <div class="col-md-2">
                    <input type="text" class="form-control" name="q" id="subsystemSearchInput" 
                           placeholder="{{ _('搜索') }}..." value="{{ search_query }}"
                           list="subsystemAutocompleteList" autocomplete="off">
                    <datalist id="subsystemAutocompleteList"></datalist>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control" name="system_code" id="systemCodeInput"
                           placeholder="{{ _('选择系统') }}" value="{{ filter_system }}"
                           list="systemCodeAutocompleteList" autocomplete="off">
                    <datalist id="systemCodeAutocompleteList"></datalist>
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="type">
                        <option value="">{{ _('全部') }}</option>
                        <option value="Process" {% if filter_type == 'Process' %}selected{% endif %}>{{ _('工艺系统') }}</option>
                        <option value="NonProcess" {% if filter_type == 'NonProcess' %}selected{% endif %}>{{ _('非工艺系统') }}</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1">
                            <i class="bi bi-search"></i> {{ _('搜索') }}
                        </button>
                        <a href="/subsystems" class="btn btn-secondary">
                            <i class="bi bi-arrow-clockwise"></i> {{ _('重置') }}
                        </a>
                        <button type="button" class="btn btn-warning" onclick="toggleFaclistFilter()">
                            <i class="bi bi-funnel"></i> {{ _('筛选') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 第二行：Faclist高级筛选（可折叠） -->
        <div id="faclistFilter" style="display: {{ 'block' if (filter_subproject or filter_train or filter_unit or filter_simpleblk or filter_mainblock or filter_block or filter_bccquarter) else 'none' }};">
            <hr style="margin: 0.75rem 0;">
            <div class="faclist-scroll">
                <select class="form-select" name="subproject_code">
                    <option value="">{{ _('全部') }} SubProject</option>
                    {% for code in faclist_options.subproject_codes %}
                    <option value="{{ code }}" {% if code == filter_subproject %}selected{% endif %}>{{ code }}</option>
                    {% endfor %}
                </select>
                <select class="form-select" name="train">
                    <option value="">{{ _('全部') }} Train</option>
                    {% for train in faclist_options.trains %}
                    <option value="{{ train }}" {% if train == filter_train %}selected{% endif %}>{{ train }}</option>
                    {% endfor %}
                </select>
                <select class="form-select" name="unit">
                    <option value="">{{ _('全部') }} Unit</option>
                    {% for unit in faclist_options.units %}
                    <option value="{{ unit }}" {% if unit == filter_unit %}selected{% endif %}>{{ unit }}</option>
                    {% endfor %}
                </select>
                <select class="form-select" name="bccquarter">
                    <option value="">{{ _('全部') }} Quarter</option>
                    {% for quarter in faclist_options.bccquarters %}
                    <option value="{{ quarter }}" {% if quarter == filter_bccquarter %}selected{% endif %}>{{ quarter }}</option>
                    {% endfor %}
                </select>
                <select class="form-select" name="simpleblk">
                    <option value="">{{ _('全部') }} SimpleBlk</option>
                    {% for blk in faclist_options.simpleblks %}
                    <option value="{{ blk }}" {% if blk == filter_simpleblk %}selected{% endif %}>{{ blk }}</option>
                    {% endfor %}
                </select>
                <select class="form-select" name="mainblock">
                    <option value="">{{ _('全部') }} MainBlock</option>
                    {% for mainblock in (available_mainblocks or []) %}
                    <option value="{{ mainblock }}" {% if mainblock == filter_mainblock %}selected{% endif %}>{{ mainblock }}</option>
                    {% endfor %}
                </select>
                <select class="form-select" name="block">
                    <option value="">全部CIA主子项</option>
                    {% for blk in (available_blocks or []) %}
                    <option value="{{ blk }}" {% if blk == filter_block %}selected{% endif %}>{{ blk }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </form>
</div>

<!-- 操作按钮 -->
<div class="mb-2 text-end">
    <a class="btn btn-primary" href="/subsystems/add">
        <i class="bi bi-plus-circle"></i> {{ _('新增子系统') }}
    </a>
</div>

<!-- 表格 -->
<div class="table-container">
    <table class="table table-hover mb-0">
        <thead>
            <tr>
                <th style="width: 150px;">{{ _('子系统代码') }}</th>
                <th style="width: 120px;">{{ _('系统代码') }}</th>
                <th style="width: 220px;">{{ _('子系统描述') }}</th>
                <th style="width: 140px;">{{ _('类型') }}</th>
                <th style="width: 200px;">{{ _('试压包') }}</th>
                <th style="width: 110px;">DIN {{ _('总数量') }}</th>
                <th style="width: 110px;">DIN {{ _('已完成数量') }}</th>
                <th style="width: 200px;">{{ _('焊接进度') }}</th>
                <th style="width: 200px;">{{ _('测试进度') }}</th>
                <th style="width: 80px;">{{ _('优先级') }}</th>
                <th style="width: 200px;">{{ _('操作') }}</th>
            </tr>
        </thead>
        <tbody>
            {% if subsystems %}
                {% for subsystem in subsystems %}
                <tr>
                    <td><strong>{{ subsystem.SubSystemCode }}</strong></td>
                    <td>{{ subsystem.SystemCode or '-' }}</td>
                    <td>{{ subsystem.SubSystemDescriptionENG or '-' }}</td>
                    {% set stats = subsystem.stats %}
                    <td>
                        {% if subsystem.ProcessOrNonProcess == 'Process' %}
                        <span class="badge badge-completed">
                            <i class="bi bi-circle-fill"></i>
                            {{ _('工艺系统') }}
                        </span>
                        {% else %}
                        <span class="badge badge-pending">
                            <i class="bi bi-circle-fill"></i>
                            {{ _('非工艺系统') }}
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if stats.total_packages %}
                        <div class="fw-semibold text-primary">{{ stats.tested_packages }}/{{ stats.total_packages }} {{ _('已完成') }}</div>
                        <div class="text-muted small">DIN {{ _('完成进度') }} {{ (stats.welding_progress * 100)|round(1) }}%</div>
                        {% else %}
                        <span class="text-muted small">{{ _('无数据') }}</span>
                        {% endif %}
                    </td>
                    <td>{{ '%.1f' % stats.total_din }}</td>
                    <td>{{ '%.1f' % stats.completed_din }}</td>
                    <td>
                        {% set welding_pct = (stats.welding_progress * 100)|round(1) %}
                        <div class="progress-meta">
                            <span>DIN {{ stats.completed_din|round(1) }}/{{ stats.total_din|round(1) }}</span>
                            <span>{{ welding_pct }}%</span>
                        </div>
                        <div class="progress progress-thin">
                            <div class="progress-bar bg-success" role="progressbar"
                                 style="width: {{ welding_pct }}%;"
                                 aria-valuenow="{{ welding_pct }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </td>
                    <td>
                        {% set test_pct = (stats.test_progress * 100)|round(1) %}
                        <div class="progress-meta">
                            <span>{{ _('试压包') }} {{ stats.tested_packages }}/{{ stats.total_packages }}</span>
                            <span>{{ test_pct }}%</span>
                        </div>
                        <div class="progress progress-thin">
                            <div class="progress-bar bg-info" role="progressbar"
                                 style="width: {{ test_pct }}%;"
                                 aria-valuenow="{{ test_pct }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </td>
                    <td class="text-center">{{ subsystem.Priority or 0 }}</td>
                    <td>
                        <div class="action-buttons">
                            <a class="btn btn-sm btn-primary" href="/subsystems/edit/{{ subsystem.SubSystemCode }}">
                                <i class="bi bi-pencil"></i> {{ _('编辑') }}
                            </a>
                            <a href="/test_packages?subsystem_code={{ subsystem.SubSystemCode }}" class="btn btn-sm btn-success">
                                <i class="bi bi-box-seam"></i> {{ _('试压包') }}
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="11" class="text-center text-muted py-4">
                        <i class="bi bi-inbox"></i> {{ _('无数据') }}
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- 分页信息 -->
{% if subsystems %}
<div class="d-flex flex-wrap justify-content-between align-items-center mt-3 gap-2">
    <div class="text-muted small">
        {% if total_count %}
        {{ _('显示') }} {{ pagination.start_index }} - {{ pagination.end_index }} / {{ total_count }}
        {% endif %}
    </div>
    {% if pagination.total_pages > 1 %}
    <nav>
        <ul class="pagination pagination-sm mb-0">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ pagination.prev_url if pagination.has_prev else '#' }}">{{ _('上一页') }}</a>
            </li>
            {% for page_num in pagination.window %}
            <li class="page-item {% if page_num == pagination.current_page %}active{% endif %}">
                <a class="page-link" href="{{ pagination.base_url }}{{ page_num }}">{{ page_num }}</a>
            </li>
            {% endfor %}
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ pagination.next_url if pagination.has_next else '#' }}">{{ _('下一页') }}</a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// 切换Faclist筛选显示
function toggleFaclistFilter() {
    var filterDiv = document.getElementById('faclistFilter');
    if (filterDiv.style.display === 'none') {
        filterDiv.style.display = 'block';
    } else {
        filterDiv.style.display = 'none';
    }
}

$(document).ready(function() {
    var submitTimer;
    
    // Faclist级联筛选 - 使用AJAX更新选项（不刷新页面）
    function updateFaclistOptions(changedField) {
        var params = {
            system_code: $('select[name="system_code"]').val() || '',
            subproject_code: $('select[name="subproject_code"]').val() || '',
            train: $('select[name="train"]').val() || '',
            unit: $('select[name="unit"]').val() || '',
            simpleblk: $('select[name="simpleblk"]').val() || '',
            mainblock: $('select[name="mainblock"]').val() || '',
            block: $('select[name="block"]').val() || '',
            bccquarter: $('select[name="bccquarter"]').val() || ''
        };
        
        $.get('/subsystems/api/faclist_options', params)
            .done(function(data) {
                console.log('Faclist 选项更新成功:', data);
                // 更新项目（不更新自己）
                if (changedField !== 'subproject_code') {
                    var select = $('select[name="subproject_code"]');
                    var current = select.val();
                    select.empty().append('<option value="">全部项目</option>');
                    $.each(data.subproject_codes || [], function(i, code) {
                        select.append('<option value="' + code + '">' + code + '</option>');
                    });
                    if (current) select.val(current);
                }
                
                // 更新项目期
                if (changedField !== 'train') {
                    var select = $('select[name="train"]');
                    var current = select.val();
                    select.empty().append('<option value="">全部项目期</option>');
                    $.each(data.trains || [], function(i, train) {
                        select.append('<option value="' + train + '">' + train + '</option>');
                    });
                    if (current) select.val(current);
                }
                
                // 更新装置
                if (changedField !== 'unit') {
                    var select = $('select[name="unit"]');
                    var current = select.val();
                    select.empty().append('<option value="">全部装置</option>');
                    $.each(data.units || [], function(i, unit) {
                        select.append('<option value="' + unit + '">' + unit + '</option>');
                    });
                    if (current) select.val(current);
                }
                
                // 更新大主项
                if (changedField !== 'simpleblk') {
                    var simpleSelect = $('select[name="simpleblk"]');
                    var currentSimple = simpleSelect.val();
                    simpleSelect.empty().append('<option value="">全部大主项</option>');
                    $.each(data.simpleblks || [], function(i, blk) {
                        simpleSelect.append('<option value="' + blk + '">' + blk + '</option>');
                    });
                    if (currentSimple) simpleSelect.val(currentSimple);
                }
                
                // 更新主项
                if (changedField !== 'mainblock') {
                    var mainSelect = $('select[name="mainblock"]');
                    var currentMain = mainSelect.val();
                    mainSelect.empty().append('<option value="">全部主项</option>');
                    var currentSimpleblk = $('select[name="simpleblk"]').val();
                    var availableMainblocks = [];
                    
                    if (currentSimpleblk && data.mainblocks && data.mainblocks[currentSimpleblk] && data.mainblocks[currentSimpleblk].length > 0) {
                        // 如果选择了 simpleblk，只显示该 simpleblk 下的 mainblocks
                        availableMainblocks = data.mainblocks[currentSimpleblk].sort();
                    } else {
                        // 如果没有选择 simpleblk，显示所有 mainblocks
                        var allMainblocks = [];
                        $.each(data.mainblocks || {}, function(simpleblk, mbs) {
                            $.each(mbs, function(i, mb) {
                                if (allMainblocks.indexOf(mb) === -1) {
                                    allMainblocks.push(mb);
                                }
                            });
                        });
                        availableMainblocks = allMainblocks.sort();
                    }
                    
                    $.each(availableMainblocks, function(i, mb) {
                        mainSelect.append('<option value="' + mb + '">' + mb + '</option>');
                    });
                    
                    // 如果当前值不在新列表中，清空它
                    if (currentMain && availableMainblocks.indexOf(currentMain) === -1) {
                        mainSelect.val('');
                        // 同时清空 block
                        $('select[name="block"]').val('');
                    } else if (currentMain) {
                        mainSelect.val(currentMain);
                    }
                }
                
                // 更新CIA主子项
                if (changedField !== 'block') {
                    var blockSelect = $('select[name="block"]');
                    var currentBlock = blockSelect.val();
                    blockSelect.empty().append('<option value="">全部CIA主子项</option>');
                    var currentMainblock = $('select[name="mainblock"]').val();
                    var availableBlocks = [];
                    
                    if (currentMainblock && data.blocks && data.blocks[currentMainblock] && data.blocks[currentMainblock].length > 0) {
                        // 如果选择了 mainblock，只显示该 mainblock 下的 blocks
                        availableBlocks = data.blocks[currentMainblock].sort();
                    } else {
                        // 如果没有选择 mainblock，显示所有 blocks
                        var allBlocks = [];
                        $.each(data.blocks || {}, function(mainblock, blks) {
                            $.each(blks, function(i, blk) {
                                if (allBlocks.indexOf(blk) === -1) {
                                    allBlocks.push(blk);
                                }
                            });
                        });
                        availableBlocks = allBlocks.sort();
                    }
                    
                    $.each(availableBlocks, function(i, blk) {
                        blockSelect.append('<option value="' + blk + '">' + blk + '</option>');
                    });
                    
                    // 如果当前值不在新列表中，清空它
                    if (currentBlock && availableBlocks.indexOf(currentBlock) === -1) {
                        blockSelect.val('');
                    } else if (currentBlock) {
                        blockSelect.val(currentBlock);
                    }
                }
                
                // 更新片区
                if (changedField !== 'bccquarter') {
                    var select = $('select[name="bccquarter"]');
                    var current = select.val();
                    select.empty().append('<option value="">全部片区</option>');
                    var availableQuarters = data.bccquarters || [];
                    $.each(availableQuarters, function(i, quarter) {
                        select.append('<option value="' + quarter + '">' + quarter + '</option>');
                    });
                    // 如果当前值不在新列表中，清空它
                    if (current && availableQuarters.indexOf(current) === -1) {
                        select.val('');
                    } else if (current) {
                        select.val(current);
                    }
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Faclist 选项加载失败:', status, error, xhr.responseText);
                console.error('请求参数:', params);
                console.error('请求URL:', '/api/faclist_options');
                // 即使失败也不影响下拉框的正常展开
            });
    }
    
    // 系统代码autocomplete
    var systemCodeInput = document.getElementById('systemCodeInput');
    var systemCodeAutocompleteList = document.getElementById('systemCodeAutocompleteList');
    var systemCodeTimer = null;
    
    if (systemCodeInput && systemCodeAutocompleteList) {
        // 初始化时加载所有系统
        fetch('/api/systems/autocomplete?limit=100')
            .then(response => response.json())
            .then(data => {
                systemCodeAutocompleteList.innerHTML = '';
                data.forEach(function(item) {
                    var option = document.createElement('option');
                    option.value = item.code;
                    option.textContent = item.label;
                    systemCodeAutocompleteList.appendChild(option);
                });
            });
        
        systemCodeInput.addEventListener('input', function() {
            var query = this.value.trim();
            clearTimeout(systemCodeTimer);
            
            if (query.length < 1) {
                // 如果为空，加载所有系统
                fetch('/api/systems/autocomplete?limit=100')
                    .then(response => response.json())
                    .then(data => {
                        systemCodeAutocompleteList.innerHTML = '';
                        data.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.code;
                            option.textContent = item.label;
                            systemCodeAutocompleteList.appendChild(option);
                        });
                    });
                return;
            }
            
            systemCodeTimer = setTimeout(function() {
                fetch('/api/systems/autocomplete?q=' + encodeURIComponent(query) + '&limit=20')
                    .then(response => response.json())
                    .then(data => {
                        systemCodeAutocompleteList.innerHTML = '';
                        data.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.code;
                            option.textContent = item.label;
                            systemCodeAutocompleteList.appendChild(option);
                        });
                    });
            }, 300);
        });
        
        // 系统代码变化时，更新Faclist
        $(systemCodeInput).on('change input', function() {
            clearTimeout(submitTimer);
            submitTimer = setTimeout(function() {
                updateFaclistOptions('system_code');
            }, 300);
        });
    }
    
    // 子系统代码autocomplete
    var subsystemSearchInput = document.getElementById('subsystemSearchInput');
    var subsystemAutocompleteList = document.getElementById('subsystemAutocompleteList');
    var subsystemSearchTimer = null;
    
    if (subsystemSearchInput && subsystemAutocompleteList) {
        subsystemSearchInput.addEventListener('input', function() {
            var query = this.value.trim();
            var systemCode = systemCodeInput ? systemCodeInput.value.trim() : '';
            clearTimeout(subsystemSearchTimer);
            
            if (query.length < 1) {
                subsystemAutocompleteList.innerHTML = '';
                return;
            }
            
            subsystemSearchTimer = setTimeout(function() {
                var url = '/api/subsystems/autocomplete?q=' + encodeURIComponent(query) + '&limit=20';
                if (systemCode) {
                    url += '&system_code=' + encodeURIComponent(systemCode);
                }
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        subsystemAutocompleteList.innerHTML = '';
                        data.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.code;
                            option.textContent = item.label;
                            subsystemAutocompleteList.appendChild(option);
                        });
                    })
                    .catch(function(error) {
                        console.error('Subsystem autocomplete error:', error);
                    });
            }, 300);
        });
    }
    
    // Faclist字段变化时，通过AJAX更新选项
    $('select[name="subproject_code"], select[name="train"], select[name="unit"], select[name="simpleblk"], select[name="mainblock"], select[name="block"], select[name="bccquarter"]').change(function() {
        var changedField = $(this).attr('name');
        
        if (changedField === 'simpleblk') {
            $('select[name="mainblock"]').val('');
            $('select[name="block"]').val('');
        } else if (changedField === 'mainblock') {
            $('select[name="block"]').val('');
        }
        
        clearTimeout(submitTimer);
        submitTimer = setTimeout(function() {
            updateFaclistOptions(changedField);
        }, 300);
    });
    
    // 页面加载时，如果 Faclist 筛选区域已展开，初始化选项
    if ($('#faclistFilter').is(':visible')) {
        updateFaclistOptions('init');
    }
});
</script>
{% endblock %}

