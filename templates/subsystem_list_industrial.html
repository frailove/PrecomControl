{% extends "base_industrial.html" %}

{% block title %}子系统管理 - 预试车管理系统{% endblock %}

{% block extra_styles %}
<style>
    .filter-section {
        background: white;
        padding: 1.25rem;
        margin-bottom: 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .table-container {
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .action-buttons {
        display: flex;
        gap: 0.375rem;
    }
    
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
    }
    
    .stat-card {
        background: white;
    padding: 0.65rem 0.9rem;
        border: 2px solid var(--border-color);
        border-left: 5px solid var(--primary-blue);
        border-radius: 8px;
        text-align: center;
    min-width: 140px;
    }
    
    .faclist-scroll {
        display: flex;
        gap: 0.6rem;
        overflow-x: auto;
        padding: 0.25rem 0;
    }
    
    .faclist-scroll .form-select {
        min-width: 150px;
        white-space: nowrap;
    }
    
    .stat-card h3 {
        font-size: 1.2rem;
        font-weight: 800;
        color: var(--primary-blue);
        margin: 0;
    }
    
    .stat-card p {
        font-size: 0.7rem;
        color: var(--text-secondary);
        margin: 0.15rem 0 0;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    
    .progress-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.72rem;
        color: var(--text-secondary);
        margin-bottom: 0.2rem;
    }
    
    .progress-thin {
        height: 6px;
        border-radius: 999px;
        overflow: hidden;
        background: #e9ecef;
    }
    
    .progress-thin .progress-bar {
        height: 100%;
    }
</style>
{% endblock %}

{% block content %}
<!-- 页面头部 -->
<div class="page-header d-flex justify-content-between align-items-end">
    <div>
        <h1>
            <i class="bi bi-bezier2"></i>
            {{ _('子系统管理') }}
        </h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/"><i class="bi bi-house-door"></i> {{ _('首页') }}</a></li>
                <li class="breadcrumb-item active">{{ _('子系统管理') }}</li>
            </ol>
        </nav>
    </div>
    <div class="row g-2 mini-stat-wrap text-end">
        <div class="col-auto">
            <div class="stat-card mini-card">
                <h3>{{ total_count }}</h3>
                <p>{{ _('总子系统数') }}</p>
            </div>
        </div>
        <div class="col-auto">
            <div class="stat-card mini-card border-left-success">
                <h3>{{ process_count }}</h3>
                <p>{{ _('工艺系统') }}</p>
            </div>
        </div>
        <div class="col-auto">
            <div class="stat-card mini-card border-left-orange">
                <h3>{{ non_process_count }}</h3>
                <p>{{ _('非工艺系统') }}</p>
            </div>
        </div>
    </div>
</div>

<!-- 筛选区域 -->
<div class="filter-section">
    <form method="GET" action="/subsystems" id="filterForm">
        <!-- 第一行：基本筛选 -->
        <div class="filter-row">
            <div class="row g-2">
                <div class="col-md-2">
                    <input type="text" class="form-control" name="q" id="subsystemSearchInput" 
                           placeholder="{{ _('搜索') }}..." value="{{ search_query }}"
                           list="subsystemAutocompleteList" autocomplete="off">
                    <datalist id="subsystemAutocompleteList"></datalist>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control" name="system_code" id="systemCodeInput"
                           placeholder="{{ _('选择系统') }}" value="{{ filter_system }}"
                           list="systemCodeAutocompleteList" autocomplete="off">
                    <datalist id="systemCodeAutocompleteList"></datalist>
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="type">
                        <option value="">{{ _('全部') }}</option>
                        <option value="Process" {% if filter_type == 'Process' %}selected{% endif %}>{{ _('工艺系统') }}</option>
                        <option value="NonProcess" {% if filter_type == 'NonProcess' %}selected{% endif %}>{{ _('非工艺系统') }}</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1">
                            <i class="bi bi-search"></i> {{ _('搜索') }}
                        </button>
                        <a href="/subsystems" class="btn btn-secondary">
                            <i class="bi bi-arrow-clockwise"></i> {{ _('重置') }}
                        </a>
                        <button type="button" class="btn btn-warning" onclick="toggleFaclistFilter('subsystems')">
                            <i class="bi bi-funnel"></i> {{ _('筛选') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 第二行：Faclist高级筛选（使用公共组件） -->
        {% set id_prefix = 'subsystems' %}
        {% set form_id = 'filterForm' %}
        {% include 'components/faclist_filter.html' %}
    </form>
</div>

<!-- 操作按钮 -->
<div class="mb-2 text-end">
    <a class="btn btn-primary" href="/subsystems/add">
        <i class="bi bi-plus-circle"></i> {{ _('新增子系统') }}
    </a>
</div>

<!-- 表格 -->
<div class="table-container">
    <table class="table table-hover mb-0">
        <thead>
            <tr>
                <th style="width: 150px;">{{ _('子系统代码') }}</th>
                <th style="width: 120px;">{{ _('系统代码') }}</th>
                <th style="width: 220px;">{{ _('子系统描述') }}</th>
                <th style="width: 140px;">{{ _('类型') }}</th>
                <th style="width: 200px;">{{ _('试压包') }}</th>
                <th style="width: 110px;">DIN {{ _('总数量') }}</th>
                <th style="width: 110px;">DIN {{ _('已完成数量') }}</th>
                <th style="width: 200px;">{{ _('焊接进度') }}</th>
                <th style="width: 200px;">{{ _('测试进度') }}</th>
                <th style="width: 80px;">{{ _('优先级') }}</th>
                <th style="width: 200px;">{{ _('操作') }}</th>
            </tr>
        </thead>
        <tbody>
            {% if subsystems %}
                {% for subsystem in subsystems %}
                <tr>
                    <td><strong>{{ subsystem.SubSystemCode }}</strong></td>
                    <td>{{ subsystem.SystemCode or '-' }}</td>
                    <td>{{ subsystem.SubSystemDescriptionENG or '-' }}</td>
                    {% set stats = subsystem.stats %}
                    <td>
                        {% if subsystem.ProcessOrNonProcess == 'Process' %}
                        <span class="badge badge-completed">
                            <i class="bi bi-circle-fill"></i>
                            {{ _('工艺系统') }}
                        </span>
                        {% else %}
                        <span class="badge badge-pending">
                            <i class="bi bi-circle-fill"></i>
                            {{ _('非工艺系统') }}
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if stats.total_packages %}
                        <div class="fw-semibold text-primary">{{ stats.tested_packages }}/{{ stats.total_packages }} {{ _('已完成') }}</div>
                        <div class="text-muted small">DIN {{ _('完成进度') }} {{ (stats.welding_progress * 100)|round(1) }}%</div>
                        {% else %}
                        <span class="text-muted small">{{ _('无数据') }}</span>
                        {% endif %}
                    </td>
                    <td>{{ '%.1f' % stats.total_din }}</td>
                    <td>{{ '%.1f' % stats.completed_din }}</td>
                    <td>
                        {% set welding_pct = (stats.welding_progress * 100)|round(1) %}
                        <div class="progress-meta">
                            <span>DIN {{ stats.completed_din|round(1) }}/{{ stats.total_din|round(1) }}</span>
                            <span>{{ welding_pct }}%</span>
                        </div>
                        <div class="progress progress-thin">
                            <div class="progress-bar bg-success" role="progressbar"
                                 style="width: {{ welding_pct }}%;"
                                 aria-valuenow="{{ welding_pct }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </td>
                    <td>
                        {% set test_pct = (stats.test_progress * 100)|round(1) %}
                        <div class="progress-meta">
                            <span>{{ _('试压包') }} {{ stats.tested_packages }}/{{ stats.total_packages }}</span>
                            <span>{{ test_pct }}%</span>
                        </div>
                        <div class="progress progress-thin">
                            <div class="progress-bar bg-info" role="progressbar"
                                 style="width: {{ test_pct }}%;"
                                 aria-valuenow="{{ test_pct }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </td>
                    <td class="text-center">{{ subsystem.Priority or 0 }}</td>
                    <td>
                        <div class="action-buttons">
                            <a class="btn btn-sm btn-primary" href="/subsystems/edit/{{ subsystem.SubSystemCode }}">
                                <i class="bi bi-pencil"></i> {{ _('编辑') }}
                            </a>
                            <a href="/test_packages?subsystem_code={{ subsystem.SubSystemCode }}" class="btn btn-sm btn-success">
                                <i class="bi bi-box-seam"></i> {{ _('试压包') }}
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="11" class="text-center text-muted py-4">
                        <i class="bi bi-inbox"></i> {{ _('无数据') }}
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- 分页信息 -->
{% if subsystems %}
<div class="d-flex flex-wrap justify-content-between align-items-center mt-3 gap-2">
    <div class="text-muted small">
        {% if total_count %}
        {{ _('显示') }} {{ pagination.start_index }} - {{ pagination.end_index }} / {{ total_count }}
        {% endif %}
    </div>
    {% if pagination.total_pages > 1 %}
    <nav>
        <ul class="pagination pagination-sm mb-0">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ pagination.prev_url if pagination.has_prev else '#' }}">{{ _('上一页') }}</a>
            </li>
            {% for page_num in pagination.window %}
            <li class="page-item {% if page_num == pagination.current_page %}active{% endif %}">
                <a class="page-link" href="{{ pagination.base_url }}{{ page_num }}">{{ page_num }}</a>
            </li>
            {% endfor %}
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ pagination.next_url if pagination.has_next else '#' }}">{{ _('下一页') }}</a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Faclist筛选器现在由公共的 faclist_filter.js 统一管理
    // 不再需要内联的 updateFaclistOptions 函数和 change 事件监听器
    
    // 系统代码autocomplete
    var systemCodeInput = document.getElementById('systemCodeInput');
    var systemCodeAutocompleteList = document.getElementById('systemCodeAutocompleteList');
    var systemCodeTimer = null;
    
    if (systemCodeInput && systemCodeAutocompleteList) {
        // 初始化时加载所有系统
        fetch('/api/systems/autocomplete?limit=100')
            .then(response => response.json())
            .then(data => {
                systemCodeAutocompleteList.innerHTML = '';
                data.forEach(function(item) {
                    var option = document.createElement('option');
                    option.value = item.code;
                    option.textContent = item.label;
                    systemCodeAutocompleteList.appendChild(option);
                });
            });
        
        systemCodeInput.addEventListener('input', function() {
            var query = this.value.trim();
            clearTimeout(systemCodeTimer);
            
            if (query.length < 1) {
                // 如果为空，加载所有系统
                fetch('/api/systems/autocomplete?limit=100')
                    .then(response => response.json())
                    .then(data => {
                        systemCodeAutocompleteList.innerHTML = '';
                        data.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.code;
                            option.textContent = item.label;
                            systemCodeAutocompleteList.appendChild(option);
                        });
                    });
                return;
            }
            
            systemCodeTimer = setTimeout(function() {
                fetch('/api/systems/autocomplete?q=' + encodeURIComponent(query) + '&limit=20')
                    .then(response => response.json())
                    .then(data => {
                        systemCodeAutocompleteList.innerHTML = '';
                        data.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.code;
                            option.textContent = item.label;
                            systemCodeAutocompleteList.appendChild(option);
                        });
                    });
            }, 300);
        });
        
        // 系统代码变化时，Faclist筛选器会自动更新（由公共的 faclist_filter.js 处理）
    }
    
    // 子系统代码autocomplete
    var subsystemSearchInput = document.getElementById('subsystemSearchInput');
    var subsystemAutocompleteList = document.getElementById('subsystemAutocompleteList');
    var subsystemSearchTimer = null;
    
    if (subsystemSearchInput && subsystemAutocompleteList) {
        subsystemSearchInput.addEventListener('input', function() {
            var query = this.value.trim();
            var systemCode = systemCodeInput ? systemCodeInput.value.trim() : '';
            clearTimeout(subsystemSearchTimer);
            
            if (query.length < 1) {
                subsystemAutocompleteList.innerHTML = '';
                return;
            }
            
            subsystemSearchTimer = setTimeout(function() {
                var url = '/api/subsystems/autocomplete?q=' + encodeURIComponent(query) + '&limit=20';
                if (systemCode) {
                    url += '&system_code=' + encodeURIComponent(systemCode);
                }
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        subsystemAutocompleteList.innerHTML = '';
                        data.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.code;
                            option.textContent = item.label;
                            subsystemAutocompleteList.appendChild(option);
                        });
                    })
                    .catch(function(error) {
                        console.error('Subsystem autocomplete error:', error);
                    });
            }, 300);
        });
    }
    
    // Faclist字段变化现在由公共的 faclist_filter.js 统一处理
});
</script>
{% endblock %}

