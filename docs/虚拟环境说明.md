# 虚拟环境使用说明

## 📋 哪些脚本需要虚拟环境？

### ✅ 不需要虚拟环境的脚本

以下脚本是**纯 PowerShell 脚本**，只使用 Windows 系统命令，**不需要虚拟环境**：

1. **`scripts/maintenance/sync_welding_files.ps1`** - 文件同步脚本
   - 功能：复制 Excel 文件
   - 使用：PowerShell 内置命令（Get-ChildItem, Copy-Item 等）
   - **不需要虚拟环境** ✅

2. **`scripts/maintenance/setup_welding_sync_task.ps1`** - 定时任务设置脚本
   - 功能：创建 Windows 定时任务
   - 使用：PowerShell 系统管理命令
   - **不需要虚拟环境** ✅

3. **`scripts/maintenance/run_sync.ps1`** - 快速启动脚本
   - 功能：后台运行同步脚本
   - **不需要虚拟环境** ✅

### ⚠️ 需要虚拟环境的脚本

以下脚本是 **Python 脚本**，需要虚拟环境：

1. **`maintenance/data_sync_pipeline.py`** - 数据同步流水线
   - 功能：导入 Excel 数据到数据库
   - **需要虚拟环境** ⚠️

2. **`welding_importer.py`** - 焊接数据导入器
   - 功能：导入焊接记录到数据库
   - **需要虚拟环境** ⚠️

3. **`scripts/core/start.ps1`** - 应用启动脚本
   - 功能：启动 Flask 应用
   - **需要虚拟环境** ⚠️（脚本会自动激活）

---

## 🔄 文件同步 vs 数据导入

### 文件同步（不需要虚拟环境）

**脚本**：`sync_welding_files.ps1`

**功能**：
- 从源文件夹复制 Excel 文件到 `nordinfo` 目录
- 替换旧的 `WeldingDB_*.xlsx` 文件
- 纯文件操作，不涉及 Python

**运行方式**：
```powershell
# 不需要虚拟环境
.\scripts\maintenance\sync_welding_files.ps1
```

### 数据导入（需要虚拟环境）

**脚本**：`data_sync_pipeline.py`

**功能**：
- 读取 `nordinfo` 中的 Excel 文件
- 导入数据到 MySQL 数据库
- 需要 Python 环境和依赖包（pandas, mysql-connector-python 等）

**运行方式**：
```powershell
# 需要激活虚拟环境
.\myenv\Scripts\Activate.ps1
python maintenance\data_sync_pipeline.py
```

---

## 🚀 自动导入选项

`sync_welding_files.ps1` 支持 `-AutoImport` 参数，可以在文件同步后自动触发数据导入：

```powershell
# 同步文件 + 自动导入数据（需要虚拟环境）
.\scripts\maintenance\sync_welding_files.ps1 -AutoImport
```

**工作原理**：
1. 先执行文件同步（不需要虚拟环境）
2. 如果同步成功，自动调用 `data_sync_pipeline.py`（需要虚拟环境）
3. 脚本会自动检测并激活虚拟环境

**注意**：
- 使用 `-AutoImport` 时，脚本会尝试自动激活虚拟环境
- 如果虚拟环境不存在或激活失败，会跳过数据导入，但文件同步仍会成功

---

## 📝 推荐工作流程

### 方案一：仅同步文件（推荐用于定时任务）

```powershell
# 每天凌晨 2:00 自动同步文件
.\scripts\maintenance\setup_welding_sync_task.ps1
```

**优点**：
- 不需要虚拟环境
- 运行速度快
- 资源占用少

**后续操作**：
- 文件同步后，可以手动或通过其他定时任务运行数据导入

### 方案二：同步 + 自动导入（推荐用于手动运行）

```powershell
# 同步文件并自动导入数据
.\scripts\maintenance\sync_welding_files.ps1 -AutoImport
```

**优点**：
- 一键完成文件同步和数据导入
- 自动化程度高

**要求**：
- 需要虚拟环境存在
- 需要数据库连接配置正确

---

## ⚙️ 定时任务配置建议

### 推荐配置：分离文件同步和数据导入

**文件同步任务**（每天凌晨 2:00）：
```powershell
# 不需要虚拟环境，运行快速
任务名称: PrecomControl_WeldingSync
运行时间: 每天 02:00
脚本: sync_welding_files.ps1
```

**数据导入任务**（每天凌晨 3:00，可选）：
```powershell
# 需要虚拟环境
任务名称: PrecomControl_DataImport
运行时间: 每天 03:00
脚本: data_sync_pipeline.py（通过 Python）
```

**优点**：
- 文件同步失败不影响数据导入
- 可以分别查看日志
- 更容易排查问题

---

## 🔍 检查虚拟环境

```powershell
# 检查虚拟环境是否存在
Test-Path "C:\Projects\PrecomControl\myenv\Scripts\python.exe"

# 检查虚拟环境中的依赖
.\myenv\Scripts\python.exe -m pip list | Select-String "pandas|mysql"
```

---

## 📋 总结

| 脚本 | 需要虚拟环境 | 说明 |
|------|------------|------|
| `sync_welding_files.ps1` | ❌ **不需要** | 纯 PowerShell 文件操作 |
| `sync_welding_files.ps1 -AutoImport` | ✅ **需要** | 会调用 Python 脚本 |
| `data_sync_pipeline.py` | ✅ **需要** | Python 数据导入脚本 |
| `start.ps1` | ✅ **需要** | 会自动激活虚拟环境 |

**结论**：
- **仅文件同步**：不需要虚拟环境 ✅
- **文件同步 + 数据导入**：需要虚拟环境 ⚠️

