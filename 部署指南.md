# PrecomControl 部署指南

> 完整的部署指南，涵盖内网和公网部署方案

## ⚠️ 重要：端口配置

**本应用固定使用端口：5000**

- ✅ **应用端口**：5000（Flask/Waitress监听）
- ✅ **Nginx端口**：80（HTTP）、443（HTTPS），转发到5000端口
- ✅ **不会占用**：8000、8203、8206等端口（保留给其他应用使用）

所有配置已固定为5000端口，启动脚本会自动检查端口占用情况。详细说明请参考 `PORT_CONFIG.md`。

---

## 📋 目录

1. [内网部署方案](#内网部署方案)
2. [公网部署方案](#公网部署方案)
3. [服务器选择说明](#服务器选择说明)
4. [快速开始](#快速开始)
5. [常见问题](#常见问题)

---

## 内网部署方案

### 方案概述

适用于内网环境，可以通过 IP 地址直接访问（如 `10.78.44.3:5000`），使用 Nginx 反向代理 + HTTPS。

### 前置条件

- ✅ Windows Server 2016+ 或 Windows 10+
- ✅ Python 3.7+
- ✅ MySQL 5.7+ 数据库
- ✅ 管理员权限
- ✅ 内网 IP：`10.78.44.3`（示例）

### 步骤 1：安装 Nginx

1. **下载 Nginx for Windows**
   - 访问：http://nginx.org/en/download.html
   - 下载最新稳定版（如 `nginx-1.24.0.zip`）
   - 解压到 `C:\nginx`

2. **验证安装**
   ```powershell
   cd C:\nginx
   .\nginx.exe -v
   ```

### 步骤 2：生成 SSL 证书（自签名）

**使用统一证书生成脚本**（推荐）：

```powershell
# 生成IP证书（内网使用）
cd C:\Projects\PrecomControl
.\scripts\core\generate_cert.ps1 -IP 10.78.44.3

# 或生成域名证书（公网使用）
.\scripts\core\generate_cert.ps1 -Domain cc7projectcontrols.com
```

**脚本功能**：
- ✅ 自动检测OpenSSL（优先使用）
- ✅ 如果未安装OpenSSL，使用PowerShell方法
- ✅ 支持IP地址和域名
- ✅ 自动备份现有证书
- ✅ 完整的错误处理和提示

**手动生成**（如果脚本不可用）：

1. **安装 OpenSSL**（如果未安装）
   - 下载：https://slproweb.com/products/Win32OpenSSL.html
   - 安装到 `C:\OpenSSL-Win64`
   - 添加到系统 PATH

2. **生成证书**
   ```powershell
   # 创建证书目录
   mkdir C:\nginx\ssl -Force
   
   # 生成自签名证书（支持IP访问）
   cd C:\nginx\ssl
   openssl req -x509 -nodes -days 3650 -newkey rsa:2048 `
     -keyout precom.key `
     -out precom.crt `
     -subj "/C=CN/ST=State/L=City/O=Organization/CN=10.78.44.3"
   ```

### 步骤 3：配置 Nginx

1. **创建配置文件**

   创建 `C:\nginx\conf\precom.conf`，内容如下：

   ```nginx
   # HTTP 服务器 - 重定向到 HTTPS
   server {
       listen 80;
       server_name 10.78.44.3;
       
       # 健康检查接口（不重定向）
       location /health {
           proxy_pass http://127.0.0.1:5000;
       }
       
       # 其他所有请求重定向到 HTTPS
       location / {
           return 301 https://$host$request_uri;
       }
   }
   
   # HTTPS 服务器 - 支持IP访问
   server {
       listen 443 ssl http2;
       server_name 10.78.44.3;
       
       # SSL 证书配置
       ssl_certificate      C:/nginx/ssl/precom.crt;
       ssl_certificate_key  C:/nginx/ssl/precom.key;
       
       # SSL 安全配置
       ssl_protocols TLSv1.2 TLSv1.3;
       ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
       ssl_prefer_server_ciphers on;
       ssl_session_cache shared:SSL:10m;
       ssl_session_timeout 10m;
       
       # 安全头部
       add_header Strict-Transport-Security "max-age=31536000" always;
       add_header X-Frame-Options "SAMEORIGIN" always;
       add_header X-Content-Type-Options "nosniff" always;
       add_header X-XSS-Protection "1; mode=block" always;
       
       # 日志配置
       access_log C:/nginx/logs/precom_access.log;
       error_log C:/nginx/logs/precom_error.log warn;
       
       # 客户端上传大小限制
       client_max_body_size 100M;
       
       # 超时配置
       proxy_connect_timeout 120s;
       proxy_send_timeout 120s;
       proxy_read_timeout 120s;
       
       # 静态文件服务
       location /static/ {
           alias C:/Projects/PrecomControl/static/;
           expires 7d;
           add_header Cache-Control "public, immutable";
       }
       
       # 健康检查
       location /health {
           proxy_pass http://127.0.0.1:5000;
           access_log off;
       }
       
       # 主应用代理
       location / {
           proxy_pass http://127.0.0.1:5000;
           
           # 代理头部
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
           proxy_set_header X-Forwarded-Host $host;
           proxy_set_header X-Forwarded-Port $server_port;
           
           # WebSocket 支持
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection "upgrade";
           
           # 禁用缓冲
           proxy_buffering off;
       }
   }
   ```

2. **修改主配置文件**

   编辑 `C:\nginx\conf\nginx.conf`，在 `http {` 块中添加：

   ```nginx
   http {
       include       mime.types;
       include       precom.conf;    # 添加这一行
       # ... 其他配置 ...
   }
   ```

### 步骤 4：配置防火墙

```powershell
# 以管理员身份运行 PowerShell

# 开放 HTTP 端口
New-NetFirewallRule -DisplayName "Precom HTTP" -Direction Inbound -LocalPort 80 -Protocol TCP -Action Allow

# 开放 HTTPS 端口
New-NetFirewallRule -DisplayName "Precom HTTPS" -Direction Inbound -LocalPort 443 -Protocol TCP -Action Allow

# 开放应用端口（如果直接访问）
New-NetFirewallRule -DisplayName "Precom App" -Direction Inbound -LocalPort 5000 -Protocol TCP -Action Allow
```

### 步骤 5：启动服务

1. **启动 Flask 应用**
   ```powershell
   cd C:\Projects\PrecomControl
   .\scripts\core\start.ps1
   ```

2. **启动 Nginx**（如果使用统一部署脚本，Nginx会自动启动）
   ```powershell
   cd C:\nginx
   .\nginx.exe -t    # 测试配置
   .\nginx.exe       # 启动服务
   ```

### 步骤 6：验证访问

- **通过 Nginx（推荐）**：
  - HTTP：`http://10.78.44.3`（自动重定向到 HTTPS）
  - HTTPS：`https://10.78.44.3`（浏览器会显示证书警告，点击"继续访问"）

- **直接访问应用**：
  - HTTP：`http://10.78.44.3:5000`

---

## 公网部署方案

### 方案概述

使用购买的域名 `cc7projectcontrols.com`（在阿里云购买），配置公网访问。

### 服务器选择

#### 选项 A：继续使用托管服务器（推荐，如果服务器有公网 IP）

**前提条件**：
- ✅ 服务器有公网 IP 地址
- ✅ 防火墙可以开放 80 和 443 端口
- ✅ 可以配置端口映射（如果服务器在 NAT 后面）

**优势**：
- ✅ 无需迁移数据和应用
- ✅ 无需重新配置环境
- ✅ 成本低（只需配置域名解析）

**配置步骤**：

1. **获取公网 IP**
   ```powershell
   # 检查当前公网 IP
   Invoke-RestMethod -Uri "https://api.ipify.org?format=json"
   ```

2. **配置域名 DNS 解析**
   - 登录阿里云域名控制台
   - 找到域名 `cc7projectcontrols.com`
   - 添加 A 记录：
     - **记录类型**：A
     - **主机记录**：@（或留空）
     - **记录值**：您的服务器公网 IP
     - **TTL**：600（10分钟）

3. **配置 Nginx（使用域名）**

   修改 `C:\nginx\conf\precom.conf`，将 `server_name` 改为域名：

   ```nginx
   server {
       listen 80;
       server_name cc7projectcontrols.com;
       # ... 其他配置 ...
   }
   
   server {
       listen 443 ssl http2;
       server_name cc7projectcontrols.com;
       # ... 其他配置 ...
   }
   ```

4. **获取正式 SSL 证书**

   **方案 1：使用 win-acme（Let's Encrypt 免费证书）**

   ```powershell
   # 下载 win-acme
   # https://www.win-acme.com/
   # 解压到 C:\win-acme
   
   cd C:\win-acme
   .\wacs.exe
   
   # 按提示操作：
   # 1. 选择 N（创建新证书）
   # 2. 选择 2（手动输入域名）
   # 3. 输入：cc7projectcontrols.com
   # 4. 选择验证方式：1（HTTP 文件验证）
   # 5. 选择存储方式：2（Nginx）
   # 6. 输入证书路径：C:\nginx\conf\ssl\
   ```

   然后更新 Nginx 配置中的证书路径：

   ```nginx
   ssl_certificate      C:/nginx/conf/ssl/cc7projectcontrols.com/fullchain.pem;
   ssl_certificate_key  C:/nginx/conf/ssl/cc7projectcontrols.com/privkey.pem;
   ```

   **方案 2：购买 SSL 证书（阿里云）**

   - 登录阿里云 SSL 证书控制台
   - 购买证书（或使用免费证书）
   - 下载 Nginx 格式证书
   - 复制到 `C:\nginx\ssl\` 目录

5. **配置端口映射（如果服务器在 NAT 后面）**

   如果服务器在内网，需要在路由器配置端口映射：
   - 外部端口 80 → 内部 IP 10.78.44.3:80
   - 外部端口 443 → 内部 IP 10.78.44.3:443

6. **验证访问**

   等待 DNS 解析生效（通常 5-30 分钟）后：
   - 访问：`https://cc7projectcontrols.com`
   - 应该能看到应用，且浏览器显示 🔒 锁图标

#### 选项 B：使用阿里云服务器

**适用场景**：
- 托管服务器没有公网 IP
- 托管服务器无法开放 80/443 端口
- 希望使用阿里云完整的云服务生态

**迁移步骤**：

1. **购买阿里云服务器**
   - 登录阿里云控制台
   - 购买 ECS 实例（推荐配置：2核4G，Windows Server 2019）
   - 选择与域名同区域（如都在华东1）

2. **配置安全组**
   - 开放端口：80（HTTP）、443（HTTPS）、3389（RDP）、5000（应用）
   - 配置规则：允许来源 0.0.0.0/0

3. **迁移应用**
   - 通过 RDP 连接到阿里云服务器
   - 安装 Python、MySQL 等环境
   - 上传项目代码
   - 配置数据库连接

4. **配置域名解析**
   - 登录阿里云域名控制台
   - 添加 A 记录指向阿里云服务器公网 IP

5. **配置 Nginx 和 SSL 证书**
   - 按照"内网部署方案"的步骤配置
   - 使用 win-acme 获取 Let's Encrypt 证书

6. **迁移数据库**
   ```powershell
   # 在旧服务器导出数据库
   mysqldump -u root -p PRECOMCONTROL > backup.sql
   
   # 在新服务器导入数据库
   mysql -u root -p PRECOMCONTROL < backup.sql
   ```

---

## 服务器选择说明

### 使用托管服务器的条件

✅ **可以使用托管服务器，如果满足以下任一条件**：
1. 服务器有公网 IP 地址
2. 可以通过路由器配置端口映射（NAT）
3. 防火墙可以开放 80 和 443 端口
4. 网络管理员允许配置公网访问

### 必须使用阿里云服务器的情况

❌ **必须使用阿里云服务器，如果**：
1. 托管服务器完全没有公网 IP，且无法配置端口映射
2. 公司网络策略禁止内网服务器对外提供服务
3. 希望使用阿里云的其他服务（CDN、WAF、负载均衡等）
4. 需要更高的网络带宽和稳定性

### 推荐方案

**如果托管服务器有公网 IP 或可以配置端口映射**：
- ✅ **推荐继续使用托管服务器**
- 原因：无需迁移，成本低，配置简单

**如果托管服务器无法对外提供服务**：
- ✅ **推荐迁移到阿里云服务器**
- 原因：完整的云服务支持，更好的网络质量

---

## 快速开始

### 内网部署（5分钟快速版）

**使用统一部署脚本**（推荐）：

```powershell
# 一键部署（自动配置Nginx、证书、防火墙）
cd C:\Projects\PrecomControl
.\scripts\core\deploy.ps1 -Mode standard -IP 10.78.44.3

# 启动应用
.\scripts\core\start.ps1
```

**手动部署**：

```powershell
# 1. 下载并解压 Nginx 到 C:\nginx

# 2. 生成证书
.\scripts\core\generate_cert.ps1 -IP 10.78.44.3

# 3. 部署（自动配置Nginx、防火墙）
.\scripts\core\deploy.ps1 -Mode standard -IP 10.78.44.3

# 4. 启动应用
.\scripts\core\start.ps1
```

### 公网部署（使用托管服务器）

**使用统一部署脚本**（推荐）：

```powershell
# 一键部署（自动配置Nginx、证书、防火墙）
cd C:\Projects\PrecomControl
.\scripts\core\deploy.ps1 -Mode standard -Domain cc7projectcontrols.com

# 启动应用
.\scripts\core\start.ps1
```

**手动部署**：

```powershell
# 1. 在阿里云配置 DNS 解析（A 记录指向服务器公网 IP）

# 2. 生成证书（使用域名）
.\scripts\core\generate_cert.ps1 -Domain cc7projectcontrols.com

# 3. 部署（自动配置Nginx、防火墙）
.\scripts\core\deploy.ps1 -Mode standard -Domain cc7projectcontrols.com

# 4. 启动应用
.\scripts\core\start.ps1
```

### 快速测试部署（无需Nginx）

```powershell
# 快速部署（直接使用Waitress提供HTTPS，无需Nginx）
.\scripts\core\deploy.ps1 -Mode quick

# 启动应用（HTTPS模式）
.\scripts\core\start.ps1 -Mode production -HTTPS
```

---

## 常见问题

### Q1: 内网访问时浏览器显示"不安全连接"？

**A:** 这是正常的，因为使用的是自签名证书。点击"高级" → "继续访问"即可。

### Q2: 公网访问时 DNS 解析不生效？

**A:** 
1. 检查 DNS 记录是否正确（A 记录，主机名 @，值是你的公网 IP）
2. 等待 5-30 分钟（DNS 传播需要时间）
3. 清除本地 DNS 缓存：`ipconfig /flushdns`

### Q3: 502 Bad Gateway 错误？

**A:**
1. 确认 Flask 应用正在运行：`netstat -ano | findstr :5000`
2. 检查 Nginx 配置中的 `proxy_pass` 地址是否正确
3. 查看应用日志：`Get-Content logs\app.log -Tail 50`

### Q4: 证书申请失败（win-acme）？

**A:**
1. 确认域名 DNS 解析已生效
2. 确认 80 端口未被占用（Let's Encrypt 需要 80 端口验证）
3. 确认防火墙已开放 80 端口

### Q5: 如何配置为 Windows 服务（开机自启）？

**A:** 使用 NSSM：

```powershell
# 下载 NSSM：https://nssm.cc/download
# 解压到 C:\nssm

# 注册 Flask 应用服务（使用统一启动脚本的服务模式）
C:\nssm\nssm.exe install PrecomApp "powershell.exe"
C:\nssm\nssm.exe set PrecomApp AppParameters "-NoProfile -ExecutionPolicy Bypass -File \"C:\Projects\PrecomControl\scripts\core\start.ps1\" -Mode service"
C:\nssm\nssm.exe set PrecomApp AppDirectory "C:\Projects\PrecomControl"
C:\nssm\nssm.exe set PrecomApp Start SERVICE_AUTO_START

# 注册 Nginx 服务
C:\nssm\nssm.exe install PrecomNginx "C:\nginx\nginx.exe"
C:\nssm\nssm.exe set PrecomNginx AppDirectory "C:\nginx"
C:\nssm\nssm.exe set PrecomNginx Start SERVICE_AUTO_START

# 启动服务
net start PrecomApp
net start PrecomNginx
```

---

## 维护操作

### 查看日志

```powershell
# Flask 应用日志
Get-Content C:\Projects\PrecomControl\logs\app.log -Tail 50 -Wait

# Nginx 访问日志
Get-Content C:\nginx\logs\precom_access.log -Tail 50 -Wait

# Nginx 错误日志
Get-Content C:\nginx\logs\precom_error.log -Tail 50 -Wait
```

### 重启服务

```powershell
# 重启 Flask 应用
net stop PrecomApp && net start PrecomApp

# 重启 Nginx
C:\nginx\nginx.exe -s reload
```

### 更新应用

```powershell
# 1. 停止服务
net stop PrecomApp

# 2. 更新代码
git pull  # 或手动更新文件

# 3. 更新依赖
pip install -r requirements.txt --upgrade

# 4. 重启服务
net start PrecomApp
```

---

## 总结

### 内网部署
- ✅ 使用 IP 地址访问（如 `https://10.78.44.3`）
- ✅ 使用自签名证书
- ✅ 适合内网环境

### 公网部署（托管服务器）
- ✅ 使用域名访问（`https://cc7projectcontrols.com`）
- ✅ 使用 Let's Encrypt 或购买的证书
- ✅ 需要公网 IP 或端口映射

### 公网部署（阿里云服务器）
- ✅ 使用域名访问
- ✅ 完整的云服务支持
- ✅ 需要迁移应用和数据

**推荐**：如果托管服务器有公网 IP，优先使用托管服务器；否则迁移到阿里云。

---

**如有问题，请查看日志文件或联系技术支持。**

